<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donuland Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .header { 
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4); 
            padding: 20px 30px; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .header h1 { 
            font-size: 2em; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        .header-controls { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }
        .sync-status { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(255,255,255,0.2); 
            padding: 8px 15px; 
            border-radius: 20px; 
            backdrop-filter: blur(10px); 
            font-size: 0.9em; 
        }
        .status-indicator { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: #27ae60; 
        }
        .nav-tabs { 
            display: flex; 
            background: #f8f9fa; 
            border-bottom: 1px solid #e9ecef; 
            padding: 0 30px; 
            overflow-x: auto; 
        }
        .nav-tab { 
            padding: 15px 25px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s ease; 
            font-weight: 600; 
            color: #6c757d; 
            white-space: nowrap; 
        }
        .nav-tab:hover { 
            background: #e9ecef; 
            color: #495057; 
        }
        .nav-tab.active { 
            color: #3498db; 
            border-bottom-color: #3498db; 
            background: white; 
        }
        .content-area { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
        }
        .tab-content { 
            display: none; 
        }
        .tab-content.active { 
            display: block; 
        }
        .form-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 10px; 
            border-left: 4px solid #3498db; 
            margin-bottom: 20px;
        }
        .form-section h3 { 
            color: #2c3e50; 
            margin-bottom: 20px; 
            font-size: 1.3em; 
        }
        .form-group { 
            margin-bottom: 20px; 
            position: relative; 
        }
        .form-group label { 
            display: block; 
            font-weight: 600; 
            color: #34495e; 
            margin-bottom: 8px; 
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1em; 
            transition: border-color 0.3s ease; 
        }
        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: #3498db; 
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); 
        }
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: inline-block; 
            text-align: center; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); 
        }
        .btn-large { 
            font-size: 1.2em; 
            padding: 15px 30px; 
        }
/* Weather Section Styles */
        .weather-section {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .weather-section h4 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .weather-display {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .weather-display h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .weather-display p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .weather-loading {
            text-align: center;
            padding: 15px;
            font-style: italic;
            opacity: 0.9;
        }

        .weather-days {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .weather-day {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
            flex: 1;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .weather-day:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.25);
        }

        .weather-day.positive {
            border-left: 4px solid #00b894;
        }

        .weather-day.warning {
            border-left: 4px solid #fdcb6e;
        }

        .weather-day.negative {
            border-left: 4px solid #e17055;
        }

        .weather-day div {
            margin: 3px 0;
            font-size: 0.9em;
        }

        .weather-day strong {
            font-size: 1em;
            font-weight: 600;
        }
        
        /* Sales Prediction Section Styles */
        .prediction-section {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(162, 155, 254, 0.3);
        }

        .prediction-section h4 {
            margin: 0 0 20px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .business-model-selection {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .radio-group label {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .radio-group label:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .radio-group input[type="radio"] {
            margin-right: 8px;
        }

        .financial-params {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .param-row label {
            flex: 1;
            font-size: 0.95em;
        }

        .param-row input, .param-row select {
            width: 150px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .prediction-results {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .prediction-loading {
            text-align: center;
            padding: 15px;
            font-style: italic;
            opacity: 0.9;
        }

        .prediction-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .prediction-metric {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .prediction-metric .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .prediction-metric .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .confidence-bar {
            background: rgba(255, 255, 255, 0.3);
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .confidence-high { background: #00b894; }
        .confidence-medium { background: #fdcb6e; }
        .confidence-low { background: #e17055; }

        .historical-data {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .historical-data h5 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }

        .historical-event {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
        }

        .historical-event .event-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .historical-event .event-details {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .manual-override {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .manual-override h5 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }

        .override-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .override-controls input {
            width: 120px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .btn-override {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .btn-override:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }
.message { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1001; 
            min-width: 300px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            cursor: pointer; 
        }
        .message.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .message.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .message.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .message.warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }

        @media (max-width: 768px) { 
            .header { 
                flex-direction: column; 
                gap: 15px; 
                text-align: center; 
            } 
            .nav-tabs { 
                padding: 0 15px; 
            } 
            .content-area { 
                padding: 20px; 
            } 
            .form-row { 
                grid-template-columns: 1fr; 
            }
            .weather-days {
                flex-direction: column;
            }
            .weather-day {
                min-width: auto;
            }
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }
            .param-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .param-row input, .param-row select {
                width: 100%;
                max-width: 200px;
            }
            .override-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .override-controls input {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍩 Donuland Management System</h1>
            <div class="header-controls">
                <div class="sync-status">
                    <div class="status-indicator"></div>
                    <span id="syncStatusText">Připojeno</span>
                </div>
                <button class="btn btn-primary" onclick="loadData()">🔄 Načíst data</button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('prediction', event)">🤖 AI Predikce</div>
            <div class="nav-tab" onclick="showTab('calendar', event)">📅 Kalendář akcí</div>
            <div class="nav-tab" onclick="showTab('analytics', event)">📊 Analýza & Trendy</div>
            <div class="nav-tab" onclick="showTab('settings', event)">⚙️ Nastavení</div>
        </div>
        
        <div class="content-area">
            <!-- Tab: AI Predikce -->
            <div id="prediction" class="tab-content active">
                <div class="form-section">
                    <h3>🎯 Základní informace akce</h3>
                    <div class="form-group">
                        <label for="eventType">Typ akce</label>
                        <select id="eventType">
                            <option value="">Vyberte typ akce</option>
                            <option value="food festival">Food festival</option>
                            <option value="veletrh">Veletrh</option>
                            <option value="koncert">Koncert/Hudební festival</option>
                            <option value="sportovni">Sportovní akce</option>
                            <option value="kulturni">Kulturní/Rodinná akce</option>
                            <option value="rodinny festival">Rodinný festival</option>
                            <option value="ostatni">Ostatní</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventName">Název akce</label>
                        <input type="text" id="eventName" placeholder="např. Burger Fest Praha">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventLocation">Město/Lokalita</label>
                            <input type="text" id="eventLocation" placeholder="např. Praha, Brno, Hostinné..." oninput="loadWeather()">
                        </div>
                        <div class="form-group">
                            <label for="eventDate">Datum začátku akce</label>
                            <input type="date" id="eventDate" onchange="loadWeather()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDuration">Délka akce (dny)</label>
                            <select id="eventDuration" onchange="loadWeather()">
                                <option value="1">1 den</option>
                                <option value="2" selected>2 dny</option>
                                <option value="3">3 dny</option>
                                <option value="4">4 dny</option>
                                <option value="5">5 dní</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expectedVisitors">Očekávaná návštěvnost</label>
                            <input type="number" id="expectedVisitors" value="2000" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="eventEnvironment">Prostředí akce</label>
                        <select id="eventEnvironment" onchange="handleEnvironmentChange()">
                            <option value="outdoor">Venkovní akce</option>
                            <option value="indoor">Vnitřní akce</option>
                        </select>
                    </div>
                    
                    <!-- Weather Section -->
                    <div id="weatherSection" class="weather-section">
                        <h4>🌤️ Předpověď počasí na celou dobu akce</h4>
                        <div id="weatherDisplay" class="weather-display">
                            <div class="weather-loading">📍 Vyberte město, datum a délku akce pro načtení počasí</div>
                        </div>
                        <div id="weatherDays" class="weather-days"></div>
                    </div>
                </div>

                <!-- Sales Prediction Section -->
                <div id="predictionSection" class="prediction-section" style="display: none;">
                    <h4>📊 Predikce prodeje a rentabilita</h4>
                    
                <h3>Model podnikání:</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <label class="business-model-option">
                        <input type="radio" name="businessModel" value="owner" checked>
                        <div>
                            <span style="font-size: 2em;">🏪</span>
                            <div style="margin-top: 5px; font-weight: bold; color: #2c3e50;">Majitel</div>
                        </div>
                    </label>
                    <label class="business-model-option">
                        <input type="radio" name="businessModel" value="franchisee">
                        <div>
                            <span style="font-size: 2em;">🤝</span>
                            <div style="margin-top: 5px; font-weight: bold; color: #2c3e50;">Franšízant</div>
                        </div>
                    </label>
                    <label class="business-model-option">
                        <input type="radio" name="businessModel" value="employee">
                        <div>
                            <span style="font-size: 2em;">👷</span>
                            <div style="margin-top: 5px; font-weight: bold; color: #2c3e50;">Zaměstnanec</div>
                        </div>
                    </label>
                </div>
                    <!-- Financial Parameters -->
                    <div class="financial-params">
                        <div class="param-row">
                            <label>Náklady na donut (Kč):</label>
                            <input type="number" id="donutCost" value="15" min="0" step="0.5">
                        </div>
                        <div class="param-row">
                            <label>Prodejní cena (Kč):</label>
                            <input type="number" id="sellingPrice" value="45" min="0" step="0.5">
                        </div>
                        <div class="param-row">
                            <label>Náklady na dopravu (Kč):</label>
                            <input type="number" id="transportCost" value="500" min="0" step="50">
                        </div>
                        <div class="param-row">
                            <label>Ostatní náklady (Kč):</label>
                            <input type="number" id="otherCosts" value="200" min="0" step="50">
                        </div>
                        <div class="param-row">
                            <label>Model nájmu:</label>
                            <select id="rentalModel" onchange="updateRentalInputs()">
                                <option value="fixed">Fixní nájem</option>
                                <option value="percentage">% z obratu</option>
                                <option value="mixed">Fix + % z obratu</option>
                            </select>
                        </div>
                        <div class="param-row" id="fixedRentalRow">
                            <label>Fixní nájem (Kč):</label>
                            <input type="number" id="fixedRental" value="5000" min="0" step="100">
                        </div>
                        <div class="param-row" id="percentageRentalRow" style="display: none;">
                            <label>% z obratu:</label>
                            <input type="number" id="percentageRental" value="15" min="0" max="50" step="0.5">
                        </div>
                    </div>

                    <!-- Prediction Results -->
                    <div id="predictionResults" class="prediction-results">
                        <div class="prediction-loading">📍 Vyplňte všechny údaje pro načtení predikce</div>
                    </div>

                    <!-- Historical Data Display -->
                    <div id="historicalData" class="historical-data" style="display: none;">
                        <h5>📋 Podobné akce z historie</h5>
                        <div id="historicalList"></div>
                    </div>

                    <!-- Manual Override -->
                    <div class="manual-override" style="display: none;" id="manualOverride">
                        <h5>✏️ Upravit predikci</h5>
                        <div class="override-controls">
                            <label>Váš odhad prodeje (ks):</label>
                            <input type="number" id="manualPrediction" min="0" step="1">
                            <button onclick="applyManualOverride()" class="btn-override">Použít úpravu</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Kalendář -->
            <div id="calendar" class="tab-content">
                <div class="form-section">
                    <h3>📅 Kalendář plánovaných akcí</h3>
                    
                    <!-- Controls for calendar -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveCurrentPrediction()">💾 Uložit aktuální predikci</button>
                        <button class="btn btn-primary" onclick="loadSavedEvents()">🔄 Načíst akce</button>
                        <button class="btn btn-primary" onclick="exportCalendar()">📤 Export kalendáře</button>
                    </div>
                    
                    <!-- Calendar view selector -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn" id="monthView" onclick="setCalendarView('month')" style="background: #3498db; color: white;">📅 Měsíční pohled</button>
                        <button class="btn" id="listView" onclick="setCalendarView('list')" style="background: #95a5a6; color: white;">📋 Seznam akcí</button>
                    </div>
                    
                    <!-- Month navigation -->
                    <div id="monthNavigation" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <button class="btn" onclick="changeMonth(-1)">« Předchozí</button>
                        <h4 id="currentMonthYear" style="margin: 0; color: #2c3e50;"></h4>
                        <button class="btn" onclick="changeMonth(1)">Následující »</button>
                    </div>
                    
                    <!-- Calendar grid -->
                    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <!-- Days of week header -->
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Po</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Út</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">St</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Čt</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Pá</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">So</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Ne</div>
                        <!-- Calendar days will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- Event list view -->
                    <div id="eventListView" style="display: none;">
                        <div id="eventList"></div>
                    </div>
                    
                    <!-- Event details modal placeholder -->
                    <div id="eventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeEventModal()">
                        <div style="background: white; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-top: 0;">Detail akce</h3>
                            <div id="eventModalContent"></div>
                            <div style="text-align: right; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="closeEventModal()">Zavřít</button>
                                <button class="btn" onclick="deleteEvent()" style="background: #e74c3c; color: white; margin-left: 10px;">Smazat akci</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Analýza -->
            <div id="analytics" class="tab-content">
                <div class="form-section">
                    <h3>📊 Analýza prodejních dat</h3>
                    <div id="analyticsContent">
                        <p>Načtěte historická data pro zobrazení analýz</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Nastavení -->
            <div id="settings" class="tab-content">
                <div class="form-section">
                    <h3>⚙️ Nastavení aplikace</h3>
                    <div class="form-group">
                        <label for="defaultDonutPrice">Výchozí cena donutu (Kč)</label>
                        <input type="number" id="defaultDonutPrice" value="110" min="0" step="5">
                    </div>
                    <div class="form-group">
                        <label for="defaultDonutCost">Výchozí náklady na donut (Kč)</label>
                        <input type="number" id="defaultDonutCost" value="32" min="0" step="1">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">💾 Uložit nastavení</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let historicalData = [];
        let lastPrediction = null;
        let currentDate = new Date();
        let calendarView = 'month';
        let savedEvents = [];
        let selectedEventId = null;

        // Weather API key
        const WEATHER_API_KEY = 'c2fb0e86623880dc86162892b0fd9c95';

        // Colors for future events
        const futureEventColors = [
            '#3498db', '#9b59b6', '#e74c3c', '#f39c12',
            '#8e44ad', '#e91e63', '#795548', '#607d8b'
        ];

        // Tab management
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Initialize calendar when switching to calendar tab
            if (tabName === 'calendar') {
                initializeCalendar();
            }
        }

        // Message display function
        function showMessage(text, type = 'info') {
            document.querySelectorAll('.message').forEach(msg => msg.remove());
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            setTimeout(() => { 
                if (message.parentNode) message.remove(); 
            }, 4000);
            message.onclick = () => message.remove();
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
            
            // Initialize systems
            loadData();
            initializePredictionSystem();
            initializeCalendar();
            
            // Auto-refresh historical data every 5 minutes
            setInterval(loadHistoricalData, 5 * 60 * 1000);
            
            showMessage('Aplikace byla úspěšně načtena', 'success');
        });

        // Load data function
        async function loadData() {
            try {
                await loadHistoricalData();
                showMessage('Data byla úspěšně načtena', 'success');
            } catch (error) {
                showMessage('Chyba při načítání dat', 'error');
                console.error('Load data error:', error);
            }
        }

        // Save settings
        function saveSettings() {
            const settings = {
                defaultDonutPrice: document.getElementById('defaultDonutPrice').value,
                defaultDonutCost: document.getElementById('defaultDonutCost').value
            };
            localStorage.setItem('donulandSettings', JSON.stringify(settings));
            showMessage('Nastavení uloženo', 'success');
        }

        // Load historical data from Google Sheets
        async function loadHistoricalData() {
            const SHEET_ID = '1LclCz9hb0hlb1D92OyVqk6Cbam7PRK6KgAzGgiGs6iE';
            const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
            
            try {
                const response = await fetch(API_URL);
                const csvText = await response.text();
                historicalData = parseCSVData(csvText);
                console.log('Historical data loaded:', historicalData.length, 'events');
            } catch (error) {
                console.error('Error loading historical data:', error);
                showMessage('Chyba při načítání historických dat', 'error');
            }
        }

        // Parse CSV data
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;

                const event = {};
                headers.forEach((header, index) => {
                    if (values[index]) {
                        event[header] = values[index].replace(/"/g, '').trim();
                    }
                });

                // Only include events with actual sales data
                if (event['realně prodáno'] && !isNaN(parseInt(event['realně prodáno']))) {
                    event.actualSales = parseInt(event['realně prodáno']);
                    event.estimatedSales = parseInt(event['odhad prodeje']) || 0;
                    event.attendance = parseInt(event['návštěvnost']) || 0;
                    event.rating = parseInt(event['hodnocení akce 1-5']) || 0;
                    event.competition = parseInt(event['konkurence']) || 1;
                    event.location = event['Lokalita'] || '';
                    event.eventName = event['Název akce'] || '';
                    event.category = event['kategorie'] || '';
                    event.weather = event['počasí'] || '';
                    event.rentalCost = parseFloat(event['Cena nájmu']) || 0;
                    
                    data.push(event);
                }
            }

            return data;
        }

        // Parse CSV line handling quotes and commas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
// Weather functions
        async function loadWeather() {
            const location = document.getElementById('eventLocation').value;
            const date = document.getElementById('eventDate').value;
            const duration = parseInt(document.getElementById('eventDuration').value);
            
            if (!location || !date) {
                document.getElementById('weatherDisplay').innerHTML = 
                    '<div class="weather-loading">📍 Vyberte město a datum pro načtení počasí</div>';
                return;
            }

            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherDays = document.getElementById('weatherDays');
            
            weatherDisplay.innerHTML = '<div class="weather-loading">🔄 Načítám předpověď počasí...</div>';
            weatherDays.innerHTML = '';

            try {
                // Get coordinates for the location
                const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(location)},CZ&limit=1&appid=${WEATHER_API_KEY}`;
                const geoResponse = await fetch(geoUrl);
                const geoData = await geoResponse.json();
                
                if (!geoData || geoData.length === 0) {
                    throw new Error('Město nenalezeno');
                }

                const lat = geoData[0].lat;
                const lon = geoData[0].lon;

                // Get weather forecast
                const weatherUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=cz`;
                const weatherResponse = await fetch(weatherUrl);
                const weatherData = await weatherResponse.json();

                // Process weather data for event days
                const eventDate = new Date(date);
                let totalTemp = 0;
                let totalRain = 0;
                let weatherDaysHtml = '';
                let weatherSummary = {
                    avgTemp: 0,
                    totalRain: 0,
                    weatherConditions: [],
                    dayDetails: []
                };

                for (let day = 0; day < duration; day++) {
                    const currentDate = new Date(eventDate);
                    currentDate.setDate(eventDate.getDate() + day);
                    
                    const dayData = weatherData.list.filter(item => {
                        const itemDate = new Date(item.dt * 1000);
                        return itemDate.toDateString() === currentDate.toDateString();
                    });

                    if (dayData.length > 0) {
                        const dayTemp = dayData.reduce((sum, item) => sum + item.main.temp, 0) / dayData.length;
                        const dayRain = dayData.reduce((sum, item) => sum + (item.rain?.['3h'] || 0), 0);
                        const dayWeather = dayData[Math.floor(dayData.length / 2)].weather[0].description;

                        totalTemp += dayTemp;
                        totalRain += dayRain;
                        weatherSummary.weatherConditions.push(dayWeather);
                        weatherSummary.dayDetails.push({
                            day: day + 1,
                            date: currentDate,
                            temp: dayTemp,
                            rain: dayRain,
                            description: dayWeather
                        });

                        // Determine weather impact class
                        let impactClass = 'positive';
                        if (dayRain > 5 || dayTemp < 10 || dayTemp > 30) {
                            impactClass = 'negative';
                        } else if (dayRain > 2 || dayTemp < 15 || dayTemp > 28) {
                            impactClass = 'warning';
                        }

                        weatherDaysHtml += `
                            <div class="weather-day ${impactClass}">
                                <strong>Den ${day + 1}</strong>
                                <div>${currentDate.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' })}</div>
                                <div>🌡️ ${Math.round(dayTemp)}°C</div>
                                <div>💧 ${dayRain.toFixed(1)} mm</div>
                                <div style="font-size: 0.85em; margin-top: 5px;">${dayWeather}</div>
                            </div>
                        `;
                    }
                }

                weatherSummary.avgTemp = totalTemp / duration;
                weatherSummary.totalRain = totalRain;

                // Update display
                const avgTemp = weatherSummary.avgTemp;
                const weatherImpact = calculateWeatherImpact(avgTemp, totalRain);
                
                weatherDisplay.innerHTML = `
                    <h5>📍 ${location} - Předpověď na ${duration} ${duration === 1 ? 'den' : duration < 5 ? 'dny' : 'dní'}</h5>
                    <p><strong>Průměrná teplota:</strong> ${avgTemp.toFixed(1)}°C</p>
                    <p><strong>Celkové srážky:</strong> ${totalRain.toFixed(1)} mm</p>
                    <p><strong>Dopad na prodej:</strong> <span style="color: ${weatherImpact.color}">${weatherImpact.text}</span></p>
                `;
                
                weatherDays.innerHTML = weatherDaysHtml;

                // Store weather data for prediction
                window.currentWeatherData = weatherSummary;
                
                // Update prediction if section is visible
                if (document.getElementById('predictionSection').style.display !== 'none') {
                    updatePrediction();
                }

            } catch (error) {
                console.error('Weather error:', error);
                weatherDisplay.innerHTML = `
                    <div style="color: #e74c3c;">
                        ⚠️ Nepodařilo se načíst počasí pro ${location}
                        <br><small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Calculate weather impact on sales
        function calculateWeatherImpact(avgTemp, totalRain) {
            if (totalRain > 10) {
                return { text: '⛈️ Velmi negativní (-30% až -50%)', color: '#e74c3c', factor: 0.6 };
            } else if (totalRain > 5) {
                return { text: '🌧️ Negativní (-20% až -30%)', color: '#e67e22', factor: 0.75 };
            } else if (avgTemp < 10 || avgTemp > 30) {
                return { text: '🌡️ Mírně negativní (-10% až -20%)', color: '#f39c12', factor: 0.85 };
            } else if (avgTemp >= 18 && avgTemp <= 25 && totalRain < 2) {
                return { text: '☀️ Ideální (+10% až +20%)', color: '#27ae60', factor: 1.15 };
            } else {
                return { text: '🌤️ Neutrální', color: '#3498db', factor: 1.0 };
            }
        }

        // Environment change handler
        function handleEnvironmentChange() {
            const environment = document.getElementById('eventEnvironment').value;
            const weatherSection = document.getElementById('weatherSection');
            
            if (environment === 'indoor') {
                weatherSection.style.opacity = '0.6';
                showMessage('Vnitřní akce - počasí má menší vliv na prodej', 'info');
            } else {
                weatherSection.style.opacity = '1';
            }
            
            if (document.getElementById('predictionSection').style.display !== 'none') {
                updatePrediction();
            }
        }

        // Initialize prediction system
        function initializePredictionSystem() {
            // Add event listeners
            const inputs = [
                'eventType', 'expectedVisitors', 'eventEnvironment',
                'donutCost', 'sellingPrice', 'transportCost', 'otherCosts',
                'fixedRental', 'percentageRental'
            ];
            
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updatePrediction);
                }
            });

            // Business model radio buttons
            document.querySelectorAll('input[name="businessModel"]').forEach(radio => {
                radio.addEventListener('change', updatePrediction);
            });

         // Show prediction section immediately and update when basic info changes
            document.getElementById('predictionSection').style.display = 'block';
                updatePrediction(); // Počítej predikci hned

        // Update rental inputs based on model
        function updateRentalInputs() {
            const model = document.getElementById('rentalModel').value;
            const fixedRow = document.getElementById('fixedRentalRow');
            const percentageRow = document.getElementById('percentageRentalRow');
            
            if (model === 'fixed') {
                fixedRow.style.display = 'flex';
                percentageRow.style.display = 'none';
            } else if (model === 'percentage') {
                fixedRow.style.display = 'none';
                percentageRow.style.display = 'flex';
            } else { // mixed
                fixedRow.style.display = 'flex';
                percentageRow.style.display = 'flex';
            }
            
            updatePrediction();
        }

        // Main prediction calculation
        async function updatePrediction() {
            const eventType = document.getElementById('eventType').value;
            const expectedVisitors = parseInt(document.getElementById('expectedVisitors').value) || 0;
            const environment = document.getElementById('eventEnvironment').value;
            const duration = parseInt(document.getElementById('eventDuration').value);
            
            if (!eventType || !expectedVisitors) {
                document.getElementById('predictionResults').innerHTML = 
                    '<div class="prediction-loading">📍 Vyplňte všechny údaje pro načtení predikce</div>';
                return;
            }

            // Show loading
            document.getElementById('predictionResults').innerHTML = 
                '<div class="prediction-loading">🔄 Počítám predikci...</div>';

            // Calculate base prediction
            let baseSales = calculateBaseSales(eventType, expectedVisitors, duration);
            
            // Apply weather factor
            let weatherFactor = 1.0;
            if (window.currentWeatherData && environment === 'outdoor') {
                const avgTemp = window.currentWeatherData.avgTemp;
                const totalRain = window.currentWeatherData.totalRain;
                weatherFactor = calculateWeatherImpact(avgTemp, totalRain).factor;
            } else if (environment === 'indoor') {
                weatherFactor = 1.0; // Indoor events are not affected by weather
            }

            // Apply historical data adjustment
            const historicalFactor = getHistoricalAdjustment(eventType, expectedVisitors);
            
            // Calculate final prediction
            const predictedSales = Math.round(baseSales * weatherFactor * historicalFactor);
            const confidence = calculateConfidence(eventType, expectedVisitors);
            
            // Financial calculations
            const financials = calculateFinancials(predictedSales);
            
            // Store last prediction
            lastPrediction = {
                eventName: document.getElementById('eventName').value,
                eventType: eventType,
                location: document.getElementById('eventLocation').value,
                date: document.getElementById('eventDate').value,
                duration: duration,
                expectedVisitors: expectedVisitors,
                predictedSales: predictedSales,
                confidence: confidence,
                financials: financials,
                weather: window.currentWeatherData
            };

            // Display results
            displayPredictionResults(predictedSales, confidence, financials);
            
            // Show historical data
            displayHistoricalData(eventType, expectedVisitors);
            
            // Show manual override
            document.getElementById('manualOverride').style.display = 'block';
            document.getElementById('manualPrediction').value = predictedSales;
        }

        // Calculate base sales
        function calculateBaseSales(eventType, visitors, duration) {
            // Base conversion rates by event type
            const conversionRates = {
                'food festival': 0.15,
                'veletrh': 0.08,
                'koncert': 0.06,
                'sportovni': 0.05,
                'kulturni': 0.10,
                'rodinny festival': 0.12,
                'ostatni': 0.08
            };
            
            const rate = conversionRates[eventType] || 0.08;
            
            // Calculate daily sales and multiply by duration
            const dailySales = visitors * rate;
            
            // Apply duration factor (slightly decreasing for longer events)
            const durationFactor = 1 + (duration - 1) * 0.8;
            
            return Math.round(dailySales * durationFactor);
        }

        // Get historical adjustment factor
        function getHistoricalAdjustment(eventType, visitors) {
            if (historicalData.length === 0) return 1.0;
            
            // Find similar events
            const similarEvents = historicalData.filter(event => {
                const typeMatch = event.category && event.category.toLowerCase().includes(eventType.toLowerCase());
                const sizeMatch = Math.abs(event.attendance - visitors) / visitors < 0.5;
                return typeMatch || sizeMatch;
            });
            
            if (similarEvents.length === 0) return 1.0;
            
            // Calculate average performance ratio
            const performanceRatios = similarEvents.map(event => {
                if (event.estimatedSales > 0) {
                    return event.actualSales / event.estimatedSales;
                }
                return 1.0;
            });
            
            const avgRatio = performanceRatios.reduce((a, b) => a + b, 0) / performanceRatios.length;
            
            // Limit adjustment to reasonable range
            return Math.max(0.7, Math.min(1.3, avgRatio));
        }

        // Calculate confidence level
        function calculateConfidence(eventType, visitors) {
            let confidence = 50; // Base confidence
            
            // Add confidence based on historical data
            const similarEvents = historicalData.filter(event => {
                return event.category && event.category.toLowerCase().includes(eventType.toLowerCase());
            });
            
            confidence += Math.min(30, similarEvents.length * 5);
            
            // Add confidence based on visitor count (more typical events = higher confidence)
            if (visitors >= 1000 && visitors <= 5000) {
                confidence += 10;
            }
            
            // Weather data availability
            if (window.currentWeatherData) {
                confidence += 10;
            }
            
            return Math.min(95, confidence);
        }
// Calculate financials
        function calculateFinancials(predictedSales) {
            const donutCost = parseFloat(document.getElementById('donutCost').value) || 15;
            const sellingPrice = parseFloat(document.getElementById('sellingPrice').value) || 45;
            const transportCost = parseFloat(document.getElementById('transportCost').value) || 500;
            const otherCosts = parseFloat(document.getElementById('otherCosts').value) || 200;
            const businessModel = document.querySelector('input[name="businessModel"]:checked').value;
            
            // Revenue
            const revenue = predictedSales * sellingPrice;
            
            // Costs
            let totalCosts = (predictedSales * donutCost) + transportCost + otherCosts;
            
            // Rental costs
            const rentalModel = document.getElementById('rentalModel').value;
            let rentalCost = 0;
            
            if (rentalModel === 'fixed') {
                rentalCost = parseFloat(document.getElementById('fixedRental').value) || 0;
            } else if (rentalModel === 'percentage') {
                const percentage = parseFloat(document.getElementById('percentageRental').value) || 0;
                rentalCost = revenue * (percentage / 100);
            } else { // mixed
                const fixed = parseFloat(document.getElementById('fixedRental').value) || 0;
                const percentage = parseFloat(document.getElementById('percentageRental').value) || 0;
                rentalCost = fixed + (revenue * (percentage / 100));
            }
            
            totalCosts += rentalCost;
            
            // Business model specific costs
            if (businessModel === 'owner') {
                // Add labor costs for workers (estimate 2 workers * 8 hours * 150 Kč/hour * duration)
                const duration = parseInt(document.getElementById('eventDuration').value);
                const laborCost = 2 * 8 * 150 * duration;
                totalCosts += laborCost;
            } else if (businessModel === 'franchisee') {
                // Add franchise fee (typically 5-10% of revenue)
                const franchiseFee = revenue * 0.07;
                totalCosts += franchiseFee;
            }
            
            // Calculate profit and margin
            const profit = revenue - totalCosts;
            const margin = revenue > 0 ? (profit / revenue) * 100 : 0;
            const breakEvenUnits = sellingPrice > donutCost ? Math.ceil((totalCosts - (predictedSales * donutCost) + rentalCost) / (sellingPrice - donutCost)) : 0;
            
            return {
                revenue: revenue,
                totalCosts: totalCosts,
                rentalCost: rentalCost,
                profit: profit,
                margin: margin,
                breakEvenUnits: breakEvenUnits,
                avgSalePerVisitor: revenue / (parseInt(document.getElementById('expectedVisitors').value) || 1)
            };
        }

        // Display prediction results
        function displayPredictionResults(predictedSales, confidence, financials) {
            const resultsDiv = document.getElementById('predictionResults');
            
            // Determine confidence level
            let confidenceClass = 'confidence-low';
            let confidenceText = 'Nízká';
            if (confidence > 70) {
                confidenceClass = 'confidence-high';
                confidenceText = 'Vysoká';
            } else if (confidence > 40) {
                confidenceClass = 'confidence-medium';
                confidenceText = 'Střední';
            }
            
            resultsDiv.innerHTML = `
                <div class="prediction-summary">
                    <div class="prediction-metric">
                        <div class="metric-value">${predictedSales.toLocaleString('cs-CZ')}</div>
                        <div class="metric-label">Predikce prodeje (ks)</div>
                    </div>
                    <div class="prediction-metric">
                        <div class="metric-value">${financials.revenue.toLocaleString('cs-CZ')} Kč</div>
                        <div class="metric-label">Očekávaný obrat</div>
                    </div>
                    <div class="prediction-metric">
                        <div class="metric-value" style="color: ${financials.profit >= 0 ? '#00b894' : '#e17055'}">
                            ${financials.profit.toLocaleString('cs-CZ')} Kč
                        </div>
                        <div class="metric-label">Očekávaný zisk</div>
                    </div>
                    <div class="prediction-metric">
                        <div class="metric-value">${financials.margin.toFixed(1)}%</div>
                        <div class="metric-label">Zisková marže</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <strong>Spolehlivost predikce: ${confidenceText}</strong>
                    <div class="confidence-bar">
                        <div class="confidence-fill ${confidenceClass}" style="width: ${confidence}%"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 6px;">
                    <h5 style="margin: 0 0 10px 0;">Detailní rozpis:</h5>
                    <div style="display: grid; gap: 8px; font-size: 0.95em;">
                        <div>📦 Náklady na donuty: ${(predictedSales * parseFloat(document.getElementById('donutCost').value)).toLocaleString('cs-CZ')} Kč</div>
                        <div>🏪 Nájem místa: ${financials.rentalCost.toLocaleString('cs-CZ')} Kč</div>
                        <div>🚚 Doprava a ostatní: ${(parseFloat(document.getElementById('transportCost').value) + parseFloat(document.getElementById('otherCosts').value)).toLocaleString('cs-CZ')} Kč</div>
                        <div>💰 Celkové náklady: ${financials.totalCosts.toLocaleString('cs-CZ')} Kč</div>
                        <div>📊 Break-even bod: ${financials.breakEvenUnits} ks</div>
                        <div>👥 Průměrný prodej/návštěvník: ${financials.avgSalePerVisitor.toFixed(2)} Kč</div>
                    </div>
                </div>
            `;
        }

        // Display historical data
        function displayHistoricalData(eventType, visitors) {
            if (historicalData.length === 0) return;
            
            const historicalDiv = document.getElementById('historicalData');
            const historicalList = document.getElementById('historicalList');
            
            // Find similar events
            const similarEvents = historicalData
                .filter(event => {
                    const typeMatch = event.category && event.category.toLowerCase().includes(eventType.toLowerCase());
                    const sizeMatch = Math.abs(event.attendance - visitors) / visitors < 0.5;
                    return typeMatch || sizeMatch;
                })
                .slice(0, 5); // Show max 5 events
            
            if (similarEvents.length > 0) {
                historicalDiv.style.display = 'block';
                
                let html = '';
                similarEvents.forEach(event => {
                    const accuracy = event.estimatedSales > 0 
                        ? Math.round((event.actualSales / event.estimatedSales) * 100) 
                        : 0;
                    
                    html += `
                        <div class="historical-event">
                            <div class="event-header">${event.eventName} - ${event.location}</div>
                            <div class="event-details">
                                Návštěvnost: ${event.attendance.toLocaleString('cs-CZ')} | 
                                Prodáno: ${event.actualSales} ks | 
                                Přesnost odhadu: ${accuracy}% |
                                Počasí: ${event.weather}
                            </div>
                        </div>
                    `;
                });
                
                historicalList.innerHTML = html;
            } else {
                historicalDiv.style.display = 'none';
            }
        }

        // Apply manual override
        function applyManualOverride() {
            const manualValue = parseInt(document.getElementById('manualPrediction').value);
            if (isNaN(manualValue) || manualValue < 0) {
                showMessage('Zadejte platnou hodnotu', 'error');
                return;
            }
            
            // Recalculate financials with manual prediction
            const financials = calculateFinancials(manualValue);
            
            // Update display
            displayPredictionResults(manualValue, 100, financials);
            
            // Update stored prediction
            if (lastPrediction) {
                lastPrediction.predictedSales = manualValue;
                lastPrediction.confidence = 100;
                lastPrediction.financials = financials;
                lastPrediction.isManualOverride = true;
            }
            
            showMessage('Predikce byla upravena', 'success');
        }

        // Calendar functions
        function initializeCalendar() {
            loadSavedEvents();
            renderCalendar();
            updateMonthYearDisplay();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('calendarGrid');
            // Keep header row (first 7 elements)
            const headerCells = Array.from(calendarGrid.children).slice(0, 7);
            calendarGrid.innerHTML = '';
            headerCells.forEach(cell => calendarGrid.appendChild(cell));
            
            // Add empty cells for days before month starts
            const startDay = firstDay === 0 ? 6 : firstDay - 1; // Convert Sunday=0 to Monday=0
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.style.cssText = 'background: #f8f9fa; padding: 10px;';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.style.cssText = 'background: white; padding: 10px; min-height: 80px; cursor: pointer; position: relative; border: 1px solid transparent;';
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.style.cssText = 'font-weight: bold; margin-bottom: 5px;';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Check for events on this day
                const dayEvents = getEventsForDay(year, month, day);
                if (dayEvents.length > 0) {
                    dayEvents.forEach((event, index) => {
                        if (index < 2) { // Show max 2 events
                            const eventDiv = document.createElement('div');
                            eventDiv.style.cssText = `
                                font-size: 0.8em; 
                                padding: 2px 4px; 
                                margin: 1px 0; 
                                border-radius: 3px; 
                                overflow: hidden; 
                                text-overflow: ellipsis; 
                                white-space: nowrap;
                                background: ${event.color || '#3498db'};
                                color: white;
                                cursor: pointer;
                            `;
                            eventDiv.textContent = event.eventName || 'Akce';
                            eventDiv.onclick = (e) => {
                                e.stopPropagation();
                                showEventDetails(event.id);
                            };
                            dayCell.appendChild(eventDiv);
                        }
                    });
                    
                    if (dayEvents.length > 2) {
                        const moreDiv = document.createElement('div');
                        moreDiv.style.cssText = 'font-size: 0.7em; color: #7f8c8d; text-align: center;';
                        moreDiv.textContent = `+${dayEvents.length - 2} další`;
                        dayCell.appendChild(moreDiv);
                    }
                }
                
                // Highlight today
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.style.backgroundColor = '#e3f2fd';
                    dayCell.style.border = '2px solid #2196f3';
                }
                
                // Hover effect
                dayCell.onmouseover = () => {
                    if (dayCell.style.border !== '2px solid rgb(33, 150, 243)') {
                        dayCell.style.backgroundColor = '#f5f5f5';
                    }
                };
                dayCell.onmouseout = () => {
                    if (dayCell.style.border !== '2px solid rgb(33, 150, 243)') {
                        dayCell.style.backgroundColor = dayEvents.length > 0 ? 'white' : 'white';
                    }
                };
                
                calendarGrid.appendChild(dayCell);
            }
        }

        function getEventsForDay(year, month, day) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return savedEvents.filter(event => {
                const eventDate = new Date(event.date);
                const endDate = new Date(eventDate);
                endDate.setDate(endDate.getDate() + (event.duration - 1));
                
                const checkDate = new Date(dateStr);
                return checkDate >= eventDate && checkDate <= endDate;
            });
        }

        function updateMonthYearDisplay() {
            const monthNames = ['Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 
                               'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'];
            document.getElementById('currentMonthYear').textContent = 
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            updateMonthYearDisplay();
        }

        function setCalendarView(view) {
            calendarView = view;
            
            if (view === 'month') {
                document.getElementById('calendarGrid').style.display = 'grid';
                document.getElementById('monthNavigation').style.display = 'flex';
                document.getElementById('eventListView').style.display = 'none';
                document.getElementById('monthView').style.background = '#3498db';
                document.getElementById('listView').style.background = '#95a5a6';
                renderCalendar();
            } else {
                document.getElementById('calendarGrid').style.display = 'none';
                document.getElementById('monthNavigation').style.display = 'none';
                document.getElementById('eventListView').style.display = 'block';
                document.getElementById('monthView').style.background = '#95a5a6';
                document.getElementById('listView').style.background = '#3498db';
                renderEventList();
            }
        }
function renderEventList() {
            const listDiv = document.getElementById('eventList');
            
            if (savedEvents.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Žádné uložené akce</p>';
                return;
            }
            
            // Sort events by date
            const sortedEvents = [...savedEvents].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '<div style="display: grid; gap: 15px;">';
            sortedEvents.forEach(event => {
                const eventDate = new Date(event.date);
                const isPast = eventDate < new Date();
                
                html += `
                    <div class="event-list-item" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 8px; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        cursor: pointer;
                        transition: all 0.3s;
                        opacity: ${isPast ? '0.7' : '1'};
                        border-left: 5px solid ${event.color || '#3498db'};
                    " onclick="showEventDetails('${event.id}')" 
                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${event.eventName}</h4>
                                <div style="color: #7f8c8d; font-size: 0.9em;">
                                    <div>📅 ${eventDate.toLocaleDateString('cs-CZ')} (${event.duration} ${event.duration === 1 ? 'den' : 'dní'})</div>
                                    <div>📍 ${event.location}</div>
                                    <div>🎪 ${event.eventType}</div>
                                    <div>👥 ${event.expectedVisitors.toLocaleString('cs-CZ')} návštěvníků</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">
                                    ${event.predictedSales.toLocaleString('cs-CZ')} ks
                                </div>
                                <div style="color: ${event.financials.profit >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                                    ${event.financials.profit >= 0 ? '+' : ''}${event.financials.profit.toLocaleString('cs-CZ')} Kč
                                </div>
                                <div style="font-size: 0.8em; color: #95a5a6; margin-top: 5px;">
                                    Spolehlivost: ${event.confidence}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
        }

        function saveCurrentPrediction() {
            if (!lastPrediction) {
                showMessage('Nejprve vytvořte predikci', 'error');
                return;
            }
            
            // Generate unique ID
            const eventId = Date.now().toString();
            
            // Get a color for the event
            const colorIndex = savedEvents.filter(e => new Date(e.date) >= new Date()).length % futureEventColors.length;
            
            // Create event object
            const event = {
                ...lastPrediction,
                id: eventId,
                savedAt: new Date().toISOString(),
                color: futureEventColors[colorIndex]
            };
            
            // Add to saved events
            savedEvents.push(event);
            
            // Save to localStorage
            localStorage.setItem('donulandEvents', JSON.stringify(savedEvents));
            
            // Refresh calendar
            if (calendarView === 'month') {
                renderCalendar();
            } else {
                renderEventList();
            }
            
            showMessage('Predikce byla uložena do kalendáře', 'success');
            
            // Clear form for new prediction
            setTimeout(() => {
                if (confirm('Chcete vytvořit novou predikci?')) {
                    resetForm();
                }
            }, 1000);
        }

        function loadSavedEvents() {
            const saved = localStorage.getItem('donulandEvents');
            if (saved) {
                savedEvents = JSON.parse(saved);
            }
        }

        function showEventDetails(eventId) {
            const event = savedEvents.find(e => e.id === eventId);
            if (!event) return;
            
            selectedEventId = eventId;
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            
            const eventDate = new Date(event.date);
            const endDate = new Date(eventDate);
            endDate.setDate(endDate.getDate() + (event.duration - 1));
            
            let weatherHtml = '';
            if (event.weather && event.weather.dayDetails) {
                weatherHtml = '<h4>Počasí:</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">';
                event.weather.dayDetails.forEach(day => {
                    weatherHtml += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>Den ${day.day}</strong>
                            <div>🌡️ ${Math.round(day.temp)}°C</div>
                            <div>💧 ${day.rain.toFixed(1)} mm</div>
                            <div style="font-size: 0.85em;">${day.description}</div>
                        </div>
                    `;
                });
                weatherHtml += '</div>';
            }
            
            content.innerHTML = `
                <h2 style="color: #2c3e50; margin-bottom: 20px;">${event.eventName}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4>Základní informace:</h4>
                        <div style="line-height: 1.8;">
                            <div>📅 <strong>Datum:</strong> ${eventDate.toLocaleDateString('cs-CZ')} - ${endDate.toLocaleDateString('cs-CZ')}</div>
                            <div>📍 <strong>Místo:</strong> ${event.location}</div>
                            <div>🎪 <strong>Typ:</strong> ${event.eventType}</div>
                            <div>👥 <strong>Očekávaná návštěvnost:</strong> ${event.expectedVisitors.toLocaleString('cs-CZ')}</div>
                            <div>⏱️ <strong>Délka:</strong> ${event.duration} ${event.duration === 1 ? 'den' : 'dní'}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4>Predikce prodeje:</h4>
                        <div style="line-height: 1.8;">
                            <div>🍩 <strong>Predikce:</strong> ${event.predictedSales.toLocaleString('cs-CZ')} ks</div>
                            <div>📊 <strong>Spolehlivost:</strong> ${event.confidence}%</div>
                            <div>💰 <strong>Očekávaný obrat:</strong> ${event.financials.revenue.toLocaleString('cs-CZ')} Kč</div>
                            <div style="color: ${event.financials.profit >= 0 ? '#27ae60' : '#e74c3c'}">
                                💵 <strong>Očekávaný zisk:</strong> ${event.financials.profit.toLocaleString('cs-CZ')} Kč
                            </div>
                            <div>📈 <strong>Marže:</strong> ${event.financials.margin.toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
                
                ${weatherHtml}
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4>Finanční rozpis:</h4>
                    <div style="display: grid; gap: 8px;">
                        <div>📦 Náklady na donuty: ${(event.predictedSales * (event.financials.totalCosts / event.predictedSales * 0.3)).toLocaleString('cs-CZ')} Kč</div>
                        <div>🏪 Nájem místa: ${event.financials.rentalCost.toLocaleString('cs-CZ')} Kč</div>
                        <div>🚚 Ostatní náklady: ${(event.financials.totalCosts - event.financials.rentalCost - (event.predictedSales * (event.financials.totalCosts / event.predictedSales * 0.3))).toLocaleString('cs-CZ')} Kč</div>
                        <div><strong>💸 Celkové náklady: ${event.financials.totalCosts.toLocaleString('cs-CZ')} Kč</strong></div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; font-size: 0.9em; color: #7f8c8d;">
                    <em>Uloženo: ${new Date(event.savedAt).toLocaleString('cs-CZ')}</em>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            selectedEventId = null;
        }

        function deleteEvent() {
            if (!selectedEventId) return;
            
            if (confirm('Opravdu chcete smazat tuto akci?')) {
                savedEvents = savedEvents.filter(e => e.id !== selectedEventId);
                localStorage.setItem('donulandEvents', JSON.stringify(savedEvents));
                
                closeEventModal();
                
                if (calendarView === 'month') {
                    renderCalendar();
                } else {
                    renderEventList();
                }
                
                showMessage('Akce byla smazána', 'success');
            }
        }

        function exportCalendar() {
            if (savedEvents.length === 0) {
                showMessage('Žádné akce k exportu', 'error');
                return;
            }
            
            // Create CSV content
            const headers = [
                'Název akce', 'Datum', 'Délka (dny)', 'Místo', 'Typ akce',
                'Očekávaní návštěvníci', 'Predikce prodeje (ks)', 'Spolehlivost (%)',
                'Očekávaný obrat (Kč)', 'Očekávaný zisk (Kč)', 'Marže (%)'
            ];
            
            const rows = savedEvents.map(event => [
                event.eventName,
                event.date,
                event.duration,
                event.location,
                event.eventType,
                event.expectedVisitors,
                event.predictedSales,
                event.confidence,
                Math.round(event.financials.revenue),
                Math.round(event.financials.profit),
                event.financials.margin.toFixed(1)
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `donuland_kalendar_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showMessage('Kalendář byl exportován', 'success');
        }

        function resetForm() {
            // Reset form fields
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('expectedVisitors').value = '';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
            
            // Reset other fields to defaults
            document.getElementById('eventDuration').value = '1';
            document.getElementById('eventEnvironment').value = 'outdoor';
            
            // Hide prediction section
            document.getElementById('predictionSection').style.display = 'none';
            
            // Clear weather
            document.getElementById('weatherDisplay').innerHTML = 
                '<div class="weather-loading">📍 Vyberte město a datum pro načtení počasí</div>';
            document.getElementById('weatherDays').innerHTML = '';
            
            // Clear prediction
            lastPrediction = null;
            window.currentWeatherData = null;
            
            showMessage('Formulář byl vyčištěn', 'info');
        }

        // Initialize tooltips (optional enhancement)
        function initTooltips() {
            const tooltips = {
                'eventType': 'Vyberte typ akce pro přesnější predikci',
                'expectedVisitors': 'Odhadněte celkový počet návštěvníků za všechny dny',
                'eventEnvironment': 'Vnitřní akce jsou méně ovlivněny počasím',
                'rentalModel': 'Vyberte způsob placení nájmu',
                'businessModel': 'Ovlivňuje výpočet dodatečných nákladů'
            };
            
            Object.entries(tooltips).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = text;
                }
            });
        }

        // Call initialization
        initTooltips();
    </script>
</body>
</html>
