<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donuland Management System</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        .header { 
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4); 
            padding: 20px 30px; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .header h1 { 
            font-size: 2em; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        .header-controls { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }
        
        .sync-status { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(255,255,255,0.2); 
            padding: 8px 15px; 
            border-radius: 20px; 
            backdrop-filter: blur(10px); 
            font-size: 0.9em; 
        }
        
        .status-indicator { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: #f39c12; 
        }
        
        .nav-tabs { 
            display: flex; 
            background: #f8f9fa; 
            border-bottom: 1px solid #e9ecef; 
            padding: 0 30px; 
            overflow-x: auto; 
        }
        
        .nav-tab { 
            padding: 15px 25px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s ease; 
            font-weight: 600; 
            color: #6c757d; 
            white-space: nowrap; 
        }
        
        .nav-tab:hover { 
            background: #e9ecef; 
            color: #495057; 
        }
        
        .nav-tab.active { 
            color: #3498db; 
            border-bottom-color: #3498db; 
            background: white; 
        }
        
        .content-area { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        .form-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 10px; 
            border-left: 4px solid #3498db; 
            margin-bottom: 20px;
        }
        
        .form-section h3 { 
            color: #2c3e50; 
            margin-bottom: 20px; 
            font-size: 1.3em; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
            position: relative; 
        }
        
        .form-group label { 
            display: block; 
            font-weight: 600; 
            color: #34495e; 
            margin-bottom: 8px; 
        }
        
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1em; 
            transition: border-color 0.3s ease; 
        }
        
        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: #3498db; 
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); 
        }
        
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: inline-block; 
            text-align: center; 
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); 
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .btn-large { 
            font-size: 1.2em; 
            padding: 15px 30px; 
        }

        /* Weather Section Styles */
        .weather-section {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .weather-section h4 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .weather-display {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .weather-display h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .weather-display p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .weather-loading {
            text-align: center;
            padding: 15px;
            font-style: italic;
            opacity: 0.9;
        }

        .weather-days {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .weather-day {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
            flex: 1;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .weather-day:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.25);
        }

        .weather-day.positive {
            border-left: 4px solid #00b894;
        }

        .weather-day.warning {
            border-left: 4px solid #fdcb6e;
        }

        .weather-day.negative {
            border-left: 4px solid #e17055;
        }

        .weather-day div {
            margin: 3px 0;
            font-size: 0.9em;
        }

        .weather-day strong {
            font-size: 1em;
            font-weight: 600;
        }
        
        /* Sales Prediction Section Styles */
        .prediction-section {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(162, 155, 254, 0.3);
        }

        .prediction-section h4 {
            margin: 0 0 20px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .business-model-selection {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .radio-group label {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .radio-group label:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .radio-group input[type="radio"] {
            margin-right: 8px;
        }

        .financial-params {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .param-row label {
            flex: 1;
            font-size: 0.95em;
        }

        .param-row input, .param-row select {
            width: 150px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .prediction-results {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .prediction-loading {
            text-align: center;
            padding: 15px;
            font-style: italic;
            opacity: 0.9;
        }

        .message { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1001; 
            min-width: 300px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            cursor: pointer; 
        }

        .message.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }

        .message.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }

        .message.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }

        .message.warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }

        @media (max-width: 768px) { 
            .header { 
                flex-direction: column; 
                gap: 15px; 
                text-align: center; 
            } 
            .nav-tabs { 
                padding: 0 15px; 
            } 
            .content-area { 
                padding: 20px; 
            } 
            .form-row { 
                grid-template-columns: 1fr; 
            }
            .weather-days {
                flex-direction: column;
            }
            .weather-day {
                min-width: auto;
            }
            .radio-group {
                flex-direction: column;
                gap: 8px;
            }
            .param-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .param-row input, .param-row select {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç© Donuland Management System</h1>
            <div class="header-controls">
                <div class="sync-status">
                    <div class="status-indicator"></div>
                    <span id="syncStatusText">P≈ôipojuji...</span>
                </div>
                <button class="btn btn-primary" onclick="loadData()">üîÑ Naƒç√≠st data</button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('prediction', event)">ü§ñ AI Predikce</div>
            <div class="nav-tab" onclick="showTab('calendar', event)">üìÖ Kalend√°≈ô akc√≠</div>
            <div class="nav-tab" onclick="showTab('analytics', event)">üìä Anal√Ωza & Trendy</div>
            <div class="nav-tab" onclick="showTab('settings', event)">‚öôÔ∏è Nastaven√≠</div>
        </div>
        
        <div class="content-area">
            <!-- Tab: AI Predikce -->
            <div id="prediction" class="tab-content active">
                <div class="form-section">
                    <h3>üéØ Z√°kladn√≠ informace akce</h3>
                    <div class="form-group">
                        <label for="eventType">Typ akce</label>
                        <select id="eventType" onchange="updatePrediction()">
                            <option value="">Vyberte typ akce</option>
                            <option value="food festival">Food festival</option>
                            <option value="veletrh">Veletrh</option>
                            <option value="koncert">Koncert/Hudebn√≠ festival</option>
                            <option value="sportovni">Sportovn√≠ akce</option>
                            <option value="kulturni">Kulturn√≠/Rodinn√° akce</option>
                            <option value="rodinny festival">Rodinn√Ω festival</option>
                            <option value="ostatni">Ostatn√≠</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventName">N√°zev akce</label>
                        <input type="text" id="eventName" placeholder="nap≈ô. Burger Fest Praha" onchange="updatePrediction()">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventLocation">Mƒõsto/Lokalita</label>
                            <input type="text" id="eventLocation" placeholder="nap≈ô. Praha, Brno, Ostrava..." oninput="handleLocationChange()">
                        </div>
                        <div class="form-group">
                            <label for="eventDate">Datum zaƒç√°tku akce</label>
                            <input type="date" id="eventDate" onchange="loadWeather()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDuration">D√©lka akce (dny)</label>
                            <select id="eventDuration" onchange="loadWeather()">
                                <option value="1">1 den</option>
                                <option value="2" selected>2 dny</option>
                                <option value="3">3 dny</option>
                                <option value="4">4 dny</option>
                                <option value="5">5 dn√≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expectedVisitors">Oƒçek√°van√° n√°v≈°tƒõvnost</label>
                            <input type="number" id="expectedVisitors" value="2000" min="0" onchange="updatePrediction()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="eventEnvironment">Prost≈ôed√≠ akce</label>
                        <select id="eventEnvironment" onchange="handleEnvironmentChange()">
                            <option value="outdoor">Venkovn√≠ akce</option>
                            <option value="indoor">Vnit≈ôn√≠ akce</option>
                        </select>
                    </div>
                    
                    <!-- Weather Section -->
                    <div id="weatherSection" class="weather-section">
                        <h4>üå§Ô∏è P≈ôedpovƒõƒè poƒças√≠ na celou dobu akce</h4>
                        <div id="weatherDisplay" class="weather-display">
                            <div class="weather-loading">üìç Vyberte mƒõsto, datum a d√©lku akce pro naƒçten√≠ poƒças√≠</div>
                        </div>
                        <div id="weatherDays" class="weather-days"></div>
                    </div>
                </div>

                <!-- Sales Prediction Section -->
                <div id="predictionSection" class="prediction-section">
                    <h4>üìä Predikce prodeje a rentabilita</h4>
                    
                    <!-- Business Model Selection -->
                    <div class="business-model-selection">
                        <h5>Model podnik√°n√≠:</h5>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="businessModel" value="owner" checked onchange="updatePrediction()">
                                üè™ Majitel
                            </label>
                            <label>
                                <input type="radio" name="businessModel" value="franchisee" onchange="updatePrediction()">
                                ü§ù Fran≈°√≠zant
                            </label>
                            <label>
                                <input type="radio" name="businessModel" value="employee" onchange="updatePrediction()">
                                üë∑ Zamƒõstnanec
                            </label>
                        </div>
                    </div>
                    
                    <!-- Financial Parameters -->
                    <div class="financial-params">
                        <div class="param-row">
                            <label>N√°klady na donut (Kƒç):</label>
                            <input type="number" id="donutCost" value="15" min="0" step="0.5" onchange="updatePrediction()">
                        </div>
                        <div class="param-row">
                            <label>Prodejn√≠ cena (Kƒç):</label>
                            <input type="number" id="sellingPrice" value="45" min="0" step="0.5" onchange="updatePrediction()">
                        </div>
                        <div class="param-row">
                            <label>N√°klady na dopravu (Kƒç):</label>
                            <input type="number" id="transportCost" value="500" min="0" step="50" onchange="updatePrediction()" readonly>
                            <div class="transport-info" id="transportInfo">Automaticky vypoƒç√≠t√°no dle vzd√°lenosti od Prahy</div>
                        </div>
                        <div class="param-row">
                            <label>Ostatn√≠ n√°klady (Kƒç):</label>
                            <input type="number" id="otherCosts" value="200" min="0" step="50" onchange="updatePrediction()">
                        </div>
                        <div class="param-row">
                            <label>Model n√°jmu:</label>
                            <select id="rentalModel" onchange="updateRentalInputs()">
                                <option value="fixed">Fixn√≠ n√°jem</option>
                                <option value="percentage">% z obratu</option>
                                <option value="mixed">Fix + % z obratu</option>
                            </select>
                        </div>
                        <div class="param-row" id="fixedRentalRow">
                            <label>Fixn√≠ n√°jem (Kƒç):</label>
                            <input type="number" id="fixedRental" value="5000" min="0" step="100" onchange="updatePrediction()">
                        </div>
                        <div class="param-row" id="percentageRentalRow" style="display: none;">
                            <label>% z obratu:</label>
                            <input type="number" id="percentageRental" value="15" min="0" max="50" step="0.5" onchange="updatePrediction()">
                        </div>
                    </div>

                    <!-- Prediction Results -->
                    <div id="predictionResults" class="prediction-results">
                        <div class="prediction-loading">üìç Vypl≈àte typ akce a n√°v≈°tƒõvnost pro naƒçten√≠ predikce</div>
                    </div>
                </div>
            </div>
            
            <!-- Other tabs -->
          <!-- =============================================================================
     ƒå√ÅST 6: HTML UPDATES PRO CALENDAR A EVENT MODALS
     =============================================================================
     Nahraƒète cel√Ω obsah kalend√°≈ô tabu t√≠mto k√≥dem: -->

            <!-- Tab: Kalend√°≈ô -->
            <div id="calendar" class="tab-content">
                <div class="form-section">
                    <h3>üìÖ Kalend√°≈ô akc√≠</h3>
                    
                    <!-- Controls for calendar -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="loadData()">üîÑ Naƒç√≠st akce ze Sheetu</button>
                        <button class="btn btn-primary" onclick="exportCalendar()">üì§ Export kalend√°≈ôe</button>
                        <button class="btn btn-primary" onclick="syncToSheet()">‚òÅÔ∏è Synchronizovat se Sheetem</button>
                    </div>
                    
                    <!-- Calendar view selector -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn" id="monthView" onclick="setCalendarView('month')" style="background: #3498db; color: white;">üìÖ Mƒõs√≠ƒçn√≠ pohled</button>
                        <button class="btn" id="listView" onclick="setCalendarView('list')" style="background: #95a5a6; color: white;">üìã Seznam akc√≠</button>
                    </div>
                    
                    <!-- Month navigation -->
                    <div id="monthNavigation" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <button class="btn" onclick="changeMonth(-1)">¬´ P≈ôedchoz√≠</button>
                        <h4 id="currentMonthYear" style="margin: 0; color: #2c3e50;"></h4>
                        <button class="btn" onclick="changeMonth(1)">N√°sleduj√≠c√≠ ¬ª</button>
                    </div>
                    
                    <!-- Calendar grid -->
                    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <!-- Days of week header -->
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Po</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">√öt</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">St</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">ƒåt</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">P√°</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">So</div>
                        <div style="background: #34495e; color: white; padding: 10px; text-align: center; font-weight: bold;">Ne</div>
                        <!-- Calendar days will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- Event list view -->
                    <div id="eventListView" style="display: none;">
                        <div id="eventList"></div>
                    </div>
                    
                    <!-- Event details modal -->
                    <div id="eventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeEventModal()">
                        <div style="background: white; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-top: 0;">Detail akce</h3>
                            <div id="eventModalContent"></div>
                            <div style="text-align: right; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="closeEventModal()">Zav≈ô√≠t</button>
                                <button class="btn" onclick="deleteEvent()" style="background: #e74c3c; color: white; margin-left: 10px;">Smazat akci</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analytics" class="tab-content">
                <div class="form-section">
                    <h3>üìä Anal√Ωza prodejn√≠ch dat</h3>
                    <div id="analyticsContent">
                        <p>Naƒç√≠t√°m analytick√° data...</p>
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="form-section">
                    <h3>‚öôÔ∏è Nastaven√≠ aplikace</h3>
                    <div class="form-group">
                        <label for="defaultDonutPrice">V√Ωchoz√≠ cena donutu (Kƒç)</label>
                        <input type="number" id="defaultDonutPrice" value="45" min="0" step="5">
                    </div>
                    <div class="form-group">
                        <label for="defaultDonutCost">V√Ωchoz√≠ n√°klady na donut (Kƒç)</label>
                        <input type="number" id="defaultDonutCost" value="15" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="defaultTransportRate">N√°klady na dopravu (Kƒç/km)</label>
                        <input type="number" id="defaultTransportRate" value="10" min="0" step="1">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">üíæ Ulo≈æit nastaven√≠</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // GLOBAL VARIABLES
        // =============================================================================
        
        let allSheetData = [];
        let historicalData = [];
        let plannedEvents = [];
        let localSavedEvents = [];
        let lastPrediction = null;
        let currentDate = new Date();
        let calendarView = 'month';
        let selectedEventId = null;

        // API keys and constants
        const WEATHER_API_KEY = 'c2fb0e86623880dc86162892b0fd9c95';
        const SHEET_ID = '1LclCz9hb0hlb1D92OyVqk6Cbam7PRK6KgAzGgiGs6iE';
        const PRAGUE_COORDS = { lat: 50.0755, lon: 14.4378 };

        const eventColors = [
            '#3498db', '#9b59b6', '#e74c3c', '#f39c12',
            '#8e44ad', '#e91e63', '#795548', '#607d8b',
            '#27ae60', '#e67e22', '#34495e', '#16a085'
        ];

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Donuland Management System...');
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
            
            loadData();
            loadSettings();
            
            showMessage('Aplikace byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
        });

        // =============================================================================
        // UI MANAGEMENT FUNCTIONS
        // =============================================================================

        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function showMessage(text, type = 'info') {
            document.querySelectorAll('.message').forEach(msg => msg.remove());
            
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => { 
                if (message.parentNode) message.remove(); 
            }, 4000);
            
            message.onclick = () => message.remove();
        }

        function updateSyncStatus(status, message) {
            const indicator = document.querySelector('.status-indicator');
            const text = document.getElementById('syncStatusText');
            
            if (status === 'success') {
                indicator.style.background = '#27ae60';
                text.textContent = 'P≈ôipojeno';
            } else if (status === 'error') {
                indicator.style.background = '#e74c3c';
                text.textContent = 'Chyba';
            } else if (status === 'loading') {
                indicator.style.background = '#f39c12';
                text.textContent = 'Naƒç√≠t√°m...';
            }
            
            if (message) {
                indicator.title = message;
                text.title = message;
            }
        }

        // =============================================================================
        // PLACEHOLDER FUNCTIONS (will be implemented in next parts)
        // =============================================================================
 // =============================================================================
        // ƒå√ÅST 2: DATA LOADING AND CSV PARSING
      

        async function loadData() {
            try {
                updateSyncStatus('loading', 'Naƒç√≠t√°m data...');
                await loadHistoricalData();
                loadLocalSavedEvents();
                updateSyncStatus('success', `Naƒçteno: ${historicalData.length} historick√Ωch, ${plannedEvents.length} pl√°novan√Ωch akc√≠`);
                showMessage('Data byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
            } catch (error) {
                updateSyncStatus('error', 'Chyba p≈ôi naƒç√≠t√°n√≠ dat');
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ dat ze Sheetu: ' + error.message, 'error');
                console.error('Load data error:', error);
                
                // Try to load fallback data
                loadFallbackData();
            }
        }

        async function loadHistoricalData() {
            try {
                console.log('üîÑ Loading data from Google Sheet...');
                updateSyncStatus('loading', 'Naƒç√≠t√°m data ze Sheetu...');
                
                // Corrected CSV export URL for public access
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
                
                console.log('Fetching from URL:', csvUrl);
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP chyba: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length < 10) {
                    throw new Error('Pr√°zdn√° nebo neplatn√° CSV data');
                }
                
                if (csvText.includes('<!DOCTYPE html>') || csvText.includes('<html>')) {
                    throw new Error('Z√≠sk√°n HTML m√≠sto CSV - zkontrolujte nastaven√≠ Sheetu (mus√≠ b√Ωt ve≈ôejnƒõ p≈ô√≠stupn√Ω)');
                }
                
                console.log('üìä Parsing CSV data...');
                console.log('CSV preview:', csvText.substring(0, 200) + '...');
                
                // Parse all data
                allSheetData = parseEnhancedCSVData(csvText);
                console.log(`üìã Parsed ${allSheetData.length} total events from sheet`);
                
                // Separate historical and planned events
                const currentDate = new Date();
                historicalData = [];
                plannedEvents = [];
                
                allSheetData.forEach(event => {
                    try {
                        if (event.eventDate && event.eventDate < currentDate) {
                            // Historical event - must have actual sales data
                            if (event.actualSales && event.actualSales > 0) {
                                historicalData.push(event);
                            }
                        } else if (event.eventDate && event.eventDate >= currentDate) {
                            // Future event - check if confirmed
                            if (event.confirmed === 'ANO' || event.confirmed === 'ano' || event.confirmed === 'Yes') {
                                plannedEvents.push(event);
                            }
                        }
                    } catch (parseError) {
                        console.warn('Error processing event:', event, parseError);
                    }
                });
                
                console.log('‚úÖ Data categorization complete:', {
                    total: allSheetData.length,
                    historical: historicalData.length,
                    planned: plannedEvents.length
                });
                
                updateSyncStatus('success', `√öspƒõ≈°nƒõ naƒçteno ze Sheetu: ${historicalData.length} historick√Ωch, ${plannedEvents.length} pl√°novan√Ωch akc√≠`);
                
            } catch (error) {
                console.error('‚ùå Critical error loading Sheet data:', error);
                throw error;
            }
        }

        function parseEnhancedCSVData(csvText) {
            console.log('üîç Starting CSV parsing...');
            
            try {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    throw new Error('CSV m√° m√©nƒõ ne≈æ 2 ≈ô√°dky (header + data)');
                }
                
                // Parse headers
                let headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                console.log('üìã Found headers:', headers);
                
                const data = [];
                let successfullyParsed = 0;
                let errors = 0;

                for (let i = 1; i < lines.length; i++) {
                    try {
                        if (lines[i].trim() === '') continue;
                        
                        const values = parseCSVLine(lines[i]);
                        
                        if (values.length < Math.min(3, headers.length)) {
                            console.warn(`≈ò√°dek ${i + 1} m√° p≈ô√≠li≈° m√°lo sloupc≈Ø:`, values);
                            errors++;
                            continue;
                        }

                        const event = {};
                        headers.forEach((header, index) => {
                            if (values[index] !== undefined) {
                                event[header] = values[index].replace(/"/g, '').trim();
                            }
                        });

                        // Enhanced data mapping with flexible field matching
                        const processedEvent = {
                            // Basic info
                            eventName: event['N√°zev akce'] || event['n√°zev akce'] || event['Event Name'] || '',
                            location: event['Lokalita'] || event['lokalita'] || event['Location'] || event['Mƒõsto'] || '',
                            category: event['kategorie'] || event['Kategorie'] || event['Category'] || event['Typ'] || '',
                            confirmed: event['POTVRZENO'] || event['potvrzeno'] || event['Confirmed'] || '',
                            
                            // Financial data
                            actualSales: parseIntSafe(event['realnƒõ prod√°no'] || event['realne prodano'] || event['Actual Sales']),
                            estimatedSales: parseIntSafe(event['odhad prodeje'] || event['Estimated Sales']),
                            attendance: parseIntSafe(event['n√°v≈°tƒõvnost'] || event['navstevnost'] || event['Attendance']),
                            
                            // Costs
                            rentalCost: parseFloatSafe(event['Cena n√°jmu'] || event['cena najmu'] || event['Rental Cost']),
                            transportCost: parseFloatSafe(event['n√°klady na cestu'] || event['naklady na cestu'] || event['Transport Cost']),
                            otherCosts: parseFloatSafe(event['ostatn√≠ n√°klady'] || event['ostatni naklady'] || event['Other Costs']),
                            
                            // Quality indicators
                            rating: parseIntSafe(event['hodnocen√≠ akce 1-5'] || event['hodnoceni akce 1-5'] || event['Rating']),
                            competition: parseIntSafe(event['konkurence'] || event['Competition'] || '1'),
                            weather: event['poƒças√≠'] || event['pocasi'] || event['Weather'] || '',
                            
                            // Meta
                            notes: event['pozn√°mka'] || event['poznamka'] || event['Notes'] || '',
                            responsiblePerson: event['KDO M√Å NA STAROST'] || event['kdo ma na starost'] || event['Responsible'] || '',
                            
                            // Parse date
                            eventDate: parseCSVDate(event['Datum'] || event['datum'] || event['Date']),
                            
                            // Generate ID
                            id: generateEventId(
                                event['N√°zev akce'] || 'event',
                                event['Datum'] || new Date().toISOString(),
                                event['Lokalita'] || 'unknown'
                            ),
                            
                            // Mark as Sheet event
                            source: 'sheet',
                            color: eventColors[data.length % eventColors.length],
                            
                            // Raw data for debugging
                            rawData: event
                        };

                        // Only include events with meaningful data
                        if (processedEvent.eventName || processedEvent.location || processedEvent.actualSales > 0) {
                            data.push(processedEvent);
                            successfullyParsed++;
                        }
                        
                    } catch (rowError) {
                        console.warn(`Chyba zpracov√°n√≠ ≈ô√°dku ${i + 1}:`, rowError, lines[i]);
                        errors++;
                    }
                }

                console.log(`‚úÖ CSV parsing complete: ${successfullyParsed} events parsed, ${errors} errors`);
                
                if (data.length === 0) {
                    throw new Error('≈Ω√°dn√© validn√≠ ud√°losti nebyly nalezeny v CSV datech');
                }

                return data;
                
            } catch (error) {
                console.error('‚ùå CSV parsing failed:', error);
                throw new Error(`Chyba parsov√°n√≠ CSV: ${error.message}`);
            }
        }

        // Utility parsing functions
        function parseIntSafe(value) {
            if (!value || value === '') return 0;
            const parsed = parseInt(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function parseFloatSafe(value) {
            if (!value || value === '') return 0;
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function parseCSVDate(dateStr) {
            if (!dateStr || dateStr.trim() === '') return null;
            
            try {
                // Try different date formats
                const formats = [
                    /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/, // DD.MM.YYYY
                    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // DD/MM/YYYY  
                    /^(\d{4})-(\d{1,2})-(\d{1,2})$/, // YYYY-MM-DD
                    /^(\d{1,2})-(\d{1,2})-(\d{4})$/ // DD-MM-YYYY
                ];
                
                for (const format of formats) {
                    const match = dateStr.trim().match(format);
                    if (match) {
                        let day, month, year;
                        
                        if (format === formats[2]) { // YYYY-MM-DD
                            [, year, month, day] = match;
                        } else { // DD.MM.YYYY, DD/MM/YYYY, DD-MM-YYYY
                            [, day, month, year] = match;
                        }
                        
                        const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        
                        // Validate date
                        if (date.getFullYear() == year && date.getMonth() == month - 1 && date.getDate() == day) {
                            return date;
                        }
                    }
                }
                
                // Try standard Date parsing as fallback
                const fallbackDate = new Date(dateStr);
                if (!isNaN(fallbackDate.getTime())) {
                    return fallbackDate;
                }
                
                console.warn('Could not parse date:', dateStr);
                return null;
                
            } catch (error) {
                console.warn('Date parsing error:', error, 'for date string:', dateStr);
                return null;
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function generateEventId(name, date, location) {
            const str = `${name}-${date}-${location}`.toLowerCase().replace(/\s+/g, '-');
            return btoa(str).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
        }

        function loadLocalSavedEvents() {
            const saved = localStorage.getItem('donulandEvents');
            if (saved) {
                try {
                    localSavedEvents = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading local events:', e);
                    localSavedEvents = [];
                }
            }
        }

        // Fallback data for testing
        function loadFallbackData() {
            console.log('üìÑ Loading fallback demo data...');
            
            historicalData = [
                {
                    id: 'demo1',
                    eventName: 'Demo Food Festival Praha',
                    location: 'Praha',
                    category: 'food festival',
                    eventDate: new Date('2024-05-15'),
                    actualSales: 850,
                    estimatedSales: 800,
                    attendance: 4500,
                    rating: 4,
                    weather: 'sluneƒçno',
                    source: 'demo'
                },
                {
                    id: 'demo2',
                    eventName: 'Demo Rodinn√Ω festival Brno',
                    location: 'Brno',
                    category: 'rodinn√Ω festival',
                    eventDate: new Date('2024-04-20'),
                    actualSales: 650,
                    estimatedSales: 700,
                    attendance: 3200,
                    rating: 5,
                    weather: 'polojasno',
                    source: 'demo'
                }
            ];
            
            plannedEvents = [];
            showMessage('Naƒçtena demo data pro testov√°n√≠', 'info');
            updateSyncStatus('success', 'Demo data naƒçtena');
        }
        // =============================================================================
        // ƒå√ÅST 3: WEATHER API AND PREDICTION SYSTEM
        // =============================================================================
        // P≈ôidejte tyto funkce p≈ôed funkci updateRentalInputs()

        // Weather functions
        async function loadWeather() {
            const location = document.getElementById('eventLocation').value;
            const date = document.getElementById('eventDate').value;
            const duration = parseInt(document.getElementById('eventDuration').value);
            
            if (!location || !date) {
                document.getElementById('weatherDisplay').innerHTML = 
                    '<div class="weather-loading">üìç Vyberte mƒõsto a datum pro naƒçten√≠ poƒças√≠</div>';
                return;
            }

            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherDays = document.getElementById('weatherDays');
            
            weatherDisplay.innerHTML = '<div class="weather-loading">üîÑ Naƒç√≠t√°m p≈ôedpovƒõƒè poƒças√≠...</div>';
            weatherDays.innerHTML = '';

            try {
                // Get coordinates for the location
                const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(location)},CZ&limit=1&appid=${WEATHER_API_KEY}`;
                const geoResponse = await fetch(geoUrl);
                const geoData = await geoResponse.json();
                
                if (!geoData || geoData.length === 0) {
                    throw new Error('Mƒõsto nenalezeno');
                }

                const lat = geoData[0].lat;
                const lon = geoData[0].lon;

                // Get weather forecast
                const weatherUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=cz`;
                const weatherResponse = await fetch(weatherUrl);
                const weatherData = await weatherResponse.json();

                // Process weather data for event days
                const eventDate = new Date(date);
                let totalTemp = 0;
                let totalRain = 0;
                let weatherDaysHtml = '';
                let weatherSummary = {
                    avgTemp: 0,
                    totalRain: 0,
                    weatherConditions: [],
                    dayDetails: []
                };

                for (let day = 0; day < duration; day++) {
                    const currentDate = new Date(eventDate);
                    currentDate.setDate(eventDate.getDate() + day);
                    
                    const dayData = weatherData.list.filter(item => {
                        const itemDate = new Date(item.dt * 1000);
                        return itemDate.toDateString() === currentDate.toDateString();
                    });

                    if (dayData.length > 0) {
                        const dayTemp = dayData.reduce((sum, item) => sum + item.main.temp, 0) / dayData.length;
                        const dayRain = dayData.reduce((sum, item) => sum + (item.rain?.['3h'] || 0), 0);
                        const dayWeather = dayData[Math.floor(dayData.length / 2)].weather[0].description;

                        totalTemp += dayTemp;
                        totalRain += dayRain;
                        weatherSummary.weatherConditions.push(dayWeather);
                        weatherSummary.dayDetails.push({
                            day: day + 1,
                            date: currentDate,
                            temp: dayTemp,
                            rain: dayRain,
                            description: dayWeather
                        });

                        // Determine weather impact class
                        let impactClass = 'positive';
                        if (dayRain > 5 || dayTemp < 10 || dayTemp > 30) {
                            impactClass = 'negative';
                        } else if (dayRain > 2 || dayTemp < 15 || dayTemp > 28) {
                            impactClass = 'warning';
                        }

                        weatherDaysHtml += `
                            <div class="weather-day ${impactClass}">
                                <strong>Den ${day + 1}</strong>
                                <div>${currentDate.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' })}</div>
                                <div>üå°Ô∏è ${Math.round(dayTemp)}¬∞C</div>
                                <div>üíß ${dayRain.toFixed(1)} mm</div>
                                <div style="font-size: 0.85em; margin-top: 5px;">${dayWeather}</div>
                            </div>
                        `;
                    }
                }

                weatherSummary.avgTemp = totalTemp / duration;
                weatherSummary.totalRain = totalRain;

                // Update display
                const avgTemp = weatherSummary.avgTemp;
                const weatherImpact = calculateWeatherImpact(avgTemp, totalRain);
                
                weatherDisplay.innerHTML = `
                    <h5>üìç ${location} - P≈ôedpovƒõƒè na ${duration} ${duration === 1 ? 'den' : duration < 5 ? 'dny' : 'dn√≠'}</h5>
                    <p><strong>Pr≈Ømƒõrn√° teplota:</strong> ${avgTemp.toFixed(1)}¬∞C</p>
                    <p><strong>Celkov√© sr√°≈æky:</strong> ${totalRain.toFixed(1)} mm</p>
                    <p><strong>Dopad na prodej:</strong> <span style="color: ${weatherImpact.color}">${weatherImpact.text}</span></p>
                `;
                
                weatherDays.innerHTML = weatherDaysHtml;

                // Store weather data for prediction
                window.currentWeatherData = weatherSummary;
                
                // Update prediction if form is filled
                updatePrediction();

            } catch (error) {
                console.error('Weather error:', error);
                weatherDisplay.innerHTML = `
                    <div style="color: #e74c3c;">
                        ‚ö†Ô∏è Nepoda≈ôilo se naƒç√≠st poƒças√≠ pro ${location}
                        <br><small>${error.message}</small>
                    </div>
                `;
            }
        }

        function calculateWeatherImpact(avgTemp, totalRain) {
            if (totalRain > 10) {
                return { text: '‚õàÔ∏è Velmi negativn√≠ (-30% a≈æ -50%)', color: '#e74c3c', factor: 0.6 };
            } else if (totalRain > 5) {
                return { text: 'üåßÔ∏è Negativn√≠ (-20% a≈æ -30%)', color: '#e67e22', factor: 0.75 };
            } else if (avgTemp < 10 || avgTemp > 30) {
                return { text: 'üå°Ô∏è M√≠rnƒõ negativn√≠ (-10% a≈æ -20%)', color: '#f39c12', factor: 0.85 };
            } else if (avgTemp >= 18 && avgTemp <= 25 && totalRain < 2) {
                return { text: '‚òÄÔ∏è Ide√°ln√≠ (+10% a≈æ +20%)', color: '#27ae60', factor: 1.15 };
            } else {
                return { text: 'üå§Ô∏è Neutr√°ln√≠', color: '#3498db', factor: 1.0 };
            }
        }

        // Location and transport cost functions
        function handleLocationChange() {
            const location = document.getElementById('eventLocation').value;
            if (location && location.length > 2) {
                setTimeout(() => {
                    loadWeather();
                    updatePrediction();
                }, 1000);
            }
        }

        function handleEnvironmentChange() {
            const environment = document.getElementById('eventEnvironment').value;
            const weatherSection = document.getElementById('weatherSection');
            
            if (environment === 'indoor') {
                weatherSection.style.opacity = '0.6';
                showMessage('Vnit≈ôn√≠ akce - poƒças√≠ m√° men≈°√≠ vliv na prodej', 'info');
            } else {
                weatherSection.style.opacity = '1';
            }
            
            updatePrediction();
        }

        async function calculateTransportCost(location) {
            if (!location) return 500; // Default cost
            
            try {
                // Get coordinates for the location
                const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(location)},CZ&limit=1&appid=${WEATHER_API_KEY}`;
                const geoResponse = await fetch(geoUrl);
                const geoData = await geoResponse.json();
                
                if (!geoData || geoData.length === 0) {
                    return 500; // Default if location not found
                }

                const lat = geoData[0].lat;
                const lon = geoData[0].lon;
                
                // Calculate distance from Prague
                const distance = calculateDistance(PRAGUE_COORDS.lat, PRAGUE_COORDS.lon, lat, lon);
                
                // Get transport rate from settings
                const transportRate = parseFloat(document.getElementById('defaultTransportRate').value) || 10;
                
                // Transport cost: rate per km (round trip) + base cost
                const transportCost = Math.round(distance * 2 * transportRate + 200);
                
                return Math.min(transportCost, 3000); // Cap at 3000 Kƒç
                
            } catch (error) {
                console.error('Error calculating transport cost:', error);
                return 500; // Default on error
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateTransportInfo(location, cost) {
            const infoDiv = document.getElementById('transportInfo');
            if (location && cost > 500) {
                const distance = Math.round((cost - 200) / 20); // Approximate distance
                infoDiv.innerHTML = `üìç ${location}: ~${distance} km od Prahy (${cost} Kƒç)`;
            } else {
                infoDiv.innerHTML = 'Automaticky vypoƒç√≠t√°no dle vzd√°lenosti od Prahy';
            }
        }

        // Enhanced prediction calculation
        async function updatePrediction() {
            const eventType = document.getElementById('eventType').value;
            const eventName = document.getElementById('eventName').value.trim();
            const eventLocation = document.getElementById('eventLocation').value.trim();
            const expectedVisitors = parseInt(document.getElementById('expectedVisitors').value) || 0;
            const environment = document.getElementById('eventEnvironment').value;
            const duration = parseInt(document.getElementById('eventDuration').value);
            
            if (!eventType || !expectedVisitors) {
                document.getElementById('predictionResults').innerHTML = 
                    '<div class="prediction-loading">üìç Vypl≈àte typ akce a n√°v≈°tƒõvnost pro naƒçten√≠ predikce</div>';
                return;
            }

            // Show loading
            document.getElementById('predictionResults').innerHTML = 
                '<div class="prediction-loading">üîÑ Poƒç√≠t√°m predikci...</div>';

            try {
                // Calculate transport cost based on distance
                const transportCost = await calculateTransportCost(eventLocation);
                document.getElementById('transportCost').value = transportCost;
                updateTransportInfo(eventLocation, transportCost);

                // Calculate base prediction using enhanced algorithm
                let baseSales = calculateEnhancedBaseSales(eventType, expectedVisitors, duration, eventLocation);
                
                // Apply weather factor
                let weatherFactor = 1.0;
                if (window.currentWeatherData && environment === 'outdoor') {
                    const avgTemp = window.currentWeatherData.avgTemp;
                    const totalRain = window.currentWeatherData.totalRain;
                    weatherFactor = calculateWeatherImpact(avgTemp, totalRain).factor;
                }

                // Apply historical data adjustment
                const historicalFactor = getEnhancedHistoricalAdjustment(eventType, expectedVisitors, eventLocation);
                
                // Apply location-specific adjustment
                const locationFactor = getLocationAdjustment(eventLocation);
                
                // Calculate final prediction
                const predictedSales = Math.round(baseSales * weatherFactor * historicalFactor * locationFactor);
                const confidence = calculateEnhancedConfidence(eventType, expectedVisitors, eventLocation);
                
                // Financial calculations
                const financials = calculateEnhancedFinancials(predictedSales);
                
                // Store prediction
                lastPrediction = {
                    eventName: eventName,
                    eventType: eventType,
                    location: eventLocation,
                    date: document.getElementById('eventDate').value,
                    duration: duration,
                    expectedVisitors: expectedVisitors,
                    predictedSales: predictedSales,
                    confidence: confidence,
                    financials: financials,
                    weather: window.currentWeatherData,
                    transportCost: transportCost,
                    factors: {
                        base: baseSales,
                        weather: weatherFactor,
                        historical: historicalFactor,
                        location: locationFactor
                    },
                    businessModel: document.querySelector('input[name="businessModel"]:checked').value,
                    environment: environment
                };

                // Display results
                displayEnhancedPredictionResults(predictedSales, confidence, financials);

            } catch (error) {
                console.error('Prediction calculation error:', error);
                document.getElementById('predictionResults').innerHTML = 
                    '<div class="prediction-loading" style="color: #e74c3c;">‚ùå Chyba p≈ôi v√Ωpoƒçtu predikce</div>';
            }
        }

        function calculateEnhancedBaseSales(eventType, visitors, duration, location) {
            // Base conversion rates refined from historical data analysis
            const conversionRates = {
                'food festival': 0.18,      // Highest - people come to eat
                'rodinny festival': 0.15,   // High - families with children
                'kulturni': 0.12,           // Medium-high - cultural events
                'ostatni': 0.10,           // Medium - other events
                'sportovni': 0.08,         // Medium-low - focused on sport
                'veletrh': 0.06,           // Lower - business focused
                'koncert': 0.04            // Lowest - entertainment focused
            };
            
            const baseRate = conversionRates[eventType] || 0.08;
            
            // Adjust rate based on historical data for this event type
            const historicalRate = getHistoricalConversionRate(eventType, location);
            const adjustedRate = historicalRate > 0 ? (baseRate + historicalRate) / 2 : baseRate;
            
            // Calculate daily sales
            const dailySales = visitors * adjustedRate;
            
            // Duration factor with diminishing returns
            let durationFactor;
            switch(duration) {
                case 1: durationFactor = 1.0; break;
                case 2: durationFactor = 1.8; break;
                case 3: durationFactor = 2.4; break;
                case 4: durationFactor = 2.8; break;
                default: durationFactor = 1 + (duration - 1) * 0.6;
            }
            
            return Math.round(dailySales * durationFactor);
        }

        function getHistoricalConversionRate(eventType, location) {
            const relevantEvents = historicalData.filter(event => 
                event.category && 
                event.category.toLowerCase().includes(eventType.toLowerCase()) &&
                event.attendance > 0 && 
                event.actualSales > 0
            );
            
            if (relevantEvents.length === 0) return 0;
            
            const rates = relevantEvents.map(event => event.actualSales / event.attendance);
            return rates.reduce((sum, rate) => sum + rate, 0) / rates.length;
        }

        function getEnhancedHistoricalAdjustment(eventType, visitors, location) {
            if (historicalData.length === 0) return 1.0;
            
            // Find similar events with weighted criteria
            const similarEvents = historicalData.filter(event => {
                let score = 0;
                
                // Type match (highest weight)
                if (event.category && event.category.toLowerCase().includes(eventType.toLowerCase())) {
                    score += 3;
                }
                
                // Size similarity (medium weight)
                if (event.attendance > 0) {
                    const sizeDiff = Math.abs(event.attendance - visitors) / visitors;
                    if (sizeDiff < 0.3) score += 2;
                    else if (sizeDiff < 0.6) score += 1;
                }
                
                // Location match (medium weight)
                if (event.location && event.location.toLowerCase() === location.toLowerCase()) {
                    score += 2;
                }
                
                return score >= 2; // Minimum similarity threshold
            });
            
            if (similarEvents.length === 0) return 1.0;
            
            // Calculate weighted performance ratios
            const performanceRatios = similarEvents.map(event => {
                if (event.estimatedSales > 0) {
                    return event.actualSales / event.estimatedSales;
                }
                return 1.0;
            });
            
            const avgRatio = performanceRatios.reduce((a, b) => a + b, 0) / performanceRatios.length;
            
            // Apply confidence weighting based on sample size
            const confidenceWeight = Math.min(1.0, similarEvents.length / 5);
            const adjustment = 1.0 + (avgRatio - 1.0) * confidenceWeight;
            
            // Limit adjustment to reasonable range
            return Math.max(0.6, Math.min(1.4, adjustment));
        }

        function getLocationAdjustment(location) {
            if (!location) return 1.0;
            
            // Major cities tend to have higher sales
            const majorCities = ['praha', 'brno', 'ostrava', 'plzen', 'liberec', 'olomouc', 'ceske budejovice', 'hradec kralove'];
            const normalizedLocation = location.toLowerCase();
            
            if (majorCities.some(city => normalizedLocation.includes(city))) {
                // Praha gets additional boost
                if (normalizedLocation.includes('praha')) {
                    return 1.2; // 20% boost for Prague
                }
                return 1.1; // 10% boost for other major cities
            }
            
            return 1.0; // Default for other locations
        }

        function calculateEnhancedConfidence(eventType, visitors, location) {
            let confidence = 40; // Lower base confidence
            
            // Historical data availability
            const typeEvents = historicalData.filter(event => 
                event.category && event.category.toLowerCase().includes(eventType.toLowerCase())
            );
            confidence += Math.min(25, typeEvents.length * 3);
            
            // Location data availability
            const locationEvents = historicalData.filter(event => 
                event.location && event.location.toLowerCase() === location.toLowerCase()
            );
            confidence += Math.min(15, locationEvents.length * 2);
            
            // Visitor count reliability (typical events have higher confidence)
            if (visitors >= 1000 && visitors <= 5000) {
                confidence += 10;
            } else if (visitors >= 500 && visitors <= 10000) {
                confidence += 5;
            }
            
            // Weather data availability
            if (window.currentWeatherData) {
                confidence += 10;
            }
            
            // Business model reliability
            const businessModel = document.querySelector('input[name="businessModel"]:checked').value;
            if (businessModel === 'owner') {
                confidence += 5; // More control = higher confidence
            }
            
            return Math.min(95, Math.max(20, confidence));
        }
        // =============================================================================
        // ƒå√ÅST 4: FINANCIAL CALCULATIONS AND DISPLAY FUNCTIONS
        // =============================================================================
        // P≈ôidejte tyto funkce p≈ôed funkci updateRentalInputs()

        function calculateEnhancedFinancials(predictedSales) {
            const donutCost = parseFloat(document.getElementById('donutCost').value) || 15;
            const sellingPrice = parseFloat(document.getElementById('sellingPrice').value) || 45;
            const transportCost = parseFloat(document.getElementById('transportCost').value) || 500;
            const otherCosts = parseFloat(document.getElementById('otherCosts').value) || 0;
            const businessModel = document.querySelector('input[name="businessModel"]:checked').value;
            
            // Revenue
            const revenue = predictedSales * sellingPrice;
            
            // Base costs
            const donutsCost = predictedSales * donutCost;
            let totalCosts = donutsCost + transportCost + otherCosts;
            
            // Rental costs
            const rentalModel = document.getElementById('rentalModel').value;
            let rentalCost = 0;
            
            if (rentalModel === 'fixed') {
                rentalCost = parseFloat(document.getElementById('fixedRental').value) || 0;
            } else if (rentalModel === 'percentage') {
                const percentage = parseFloat(document.getElementById('percentageRental').value) || 0;
                rentalCost = revenue * (percentage / 100);
            } else { // mixed
                const fixed = parseFloat(document.getElementById('fixedRental').value) || 0;
                const percentage = parseFloat(document.getElementById('percentageRental').value) || 0;
                rentalCost = fixed + (revenue * (percentage / 100));
            }
            
            totalCosts += rentalCost;
            
            // Business model specific costs
            const duration = parseInt(document.getElementById('eventDuration').value);
            if (businessModel === 'owner') {
                // Add labor costs for workers (estimate 2 workers * 8 hours * 150 Kƒç/hour * duration)
                const laborCost = 2 * 8 * 150 * duration;
                totalCosts += laborCost;
            } else if (businessModel === 'franchisee') {
                // Add franchise fee (typically 5-10% of revenue)
                const franchiseFee = revenue * 0.07;
                totalCosts += franchiseFee;
            }
            
            // Calculate profit and margin
            const profit = revenue - totalCosts;
            const margin = revenue > 0 ? (profit / revenue) * 100 : 0;
            const breakEvenUnits = sellingPrice > donutCost ? 
                Math.ceil((totalCosts - donutsCost) / (sellingPrice - donutCost)) : 0;
            
            return {
                revenue: revenue,
                totalCosts: totalCosts,
                rentalCost: rentalCost,
                donutsCost: donutsCost,
                profit: profit,
                margin: margin,
                breakEvenUnits: breakEvenUnits,
                avgSalePerVisitor: revenue / (parseInt(document.getElementById('expectedVisitors').value) || 1)
            };
        }

        function displayEnhancedPredictionResults(predictedSales, confidence, financials) {
            const resultsDiv = document.getElementById('predictionResults');
            
            // Determine confidence level
            let confidenceClass = 'confidence-low';
            let confidenceText = 'N√≠zk√°';
            if (confidence > 70) {
                confidenceClass = 'confidence-high';
                confidenceText = 'Vysok√°';
            } else if (confidence > 40) {
                confidenceClass = 'confidence-medium';
                confidenceText = 'St≈ôedn√≠';
            }
            
            resultsDiv.innerHTML = `
                <div class="prediction-summary">
                    <div class="prediction-metric">
                        <div class="metric-value">${predictedSales.toLocaleString('cs-CZ')}</div>
                        <div class="metric-label">Predikce prodeje (ks)</div>
                    </div>
                    <div class="prediction-metric">
                        <div class="metric-value">${Math.round(financials.revenue).toLocaleString('cs-CZ')} Kƒç</div>
                        <div class="metric-label">Oƒçek√°van√Ω obrat</div>
                    </div>
                    <div class="prediction-metric">
                        <div class="metric-value" style="color: ${financials.profit >= 0 ? '#00b894' : '#e17055'}">
                            ${Math.round(financials.profit).toLocaleString('cs-CZ')} Kƒç
                        </div>
                        <div class="metric-label">Oƒçek√°van√Ω zisk</div>
                    </div>
                    <div class="prediction-metric">
                        <div class="metric-value">${financials.margin.toFixed(1)}%</div>
                        <div class="metric-label">Ziskov√° mar≈æe</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <strong>Spolehlivost predikce: ${confidenceText} (${confidence}%)</strong>
                    <div class="confidence-bar">
                        <div class="confidence-fill ${confidenceClass}" style="width: ${confidence}%"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 6px;">
                    <h5 style="margin: 0 0 10px 0;">Detailn√≠ rozpis n√°klad≈Ø:</h5>
                    <div style="display: grid; gap: 8px; font-size: 0.95em;">
                        <div>üì¶ N√°klady na donuty: ${Math.round(financials.donutsCost).toLocaleString('cs-CZ')} Kƒç</div>
                        <div>üè™ N√°jem m√≠sta: ${Math.round(financials.rentalCost).toLocaleString('cs-CZ')} Kƒç</div>
                        <div>üöö Doprava: ${parseInt(document.getElementById('transportCost').value).toLocaleString('cs-CZ')} Kƒç</div>
                        <div>üíº Ostatn√≠ n√°klady: ${parseInt(document.getElementById('otherCosts').value).toLocaleString('cs-CZ')} Kƒç</div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 5px; margin-top: 5px;">
                            <strong>üí∞ Celkov√© n√°klady: ${Math.round(financials.totalCosts).toLocaleString('cs-CZ')} Kƒç</strong>
                        </div>
                        <div>üìä Break-even bod: ${financials.breakEvenUnits} ks</div>
                        <div>üë• Pr≈Ømƒõrn√Ω prodej/n√°v≈°tƒõvn√≠k: ${financials.avgSalePerVisitor.toFixed(2)} Kƒç</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success btn-large" onclick="saveCurrentPrediction()" style="margin-right: 10px;">
                        üìÖ Ulo≈æit do kalend√°≈ôe
                    </button>
                    <button class="btn btn-primary" onclick="showManualOverride()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                        ‚úèÔ∏è Upravit predikci
                    </button>
                </div>
            `;
        }

        function showManualOverride() {
            if (!lastPrediction) {
                showMessage('Nejprve vytvo≈ôte predikci', 'error');
                return;
            }
            
            const overrideHtml = `
                <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-top: 15px; backdrop-filter: blur(10px);">
                    <h5 style="margin: 0 0 15px 0; font-size: 1.1em;">‚úèÔ∏è Upravit predikci</h5>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label>V√°≈° odhad prodeje (ks):</label>
                        <input type="number" id="manualPrediction" value="${lastPrediction.predictedSales}" min="0" step="1" style="width: 120px; padding: 8px 12px; border: none; border-radius: 4px; background: rgba(255, 255, 255, 0.9); color: #333;">
                        <button onclick="applyManualOverride()" style="background: rgba(255, 255, 255, 0.25); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(5px);">
                            Pou≈æ√≠t √∫pravu
                        </button>
                    </div>
                </div>
            `;
            
            // Add to prediction results
            const resultsDiv = document.getElementById('predictionResults');
            resultsDiv.innerHTML += overrideHtml;
        }

        function applyManualOverride() {
            const manualValue = parseInt(document.getElementById('manualPrediction').value);
            if (isNaN(manualValue) || manualValue < 0) {
                showMessage('Zadejte platnou hodnotu', 'error');
                return;
            }
            
            // Recalculate financials with manual prediction
            const financials = calculateEnhancedFinancials(manualValue);
            
            // Update display
            displayEnhancedPredictionResults(manualValue, 100, financials);
            
            // Update stored prediction
            if (lastPrediction) {
                lastPrediction.predictedSales = manualValue;
                lastPrediction.confidence = 100;
                lastPrediction.financials = financials;
                lastPrediction.isManualOverride = true;
            }
            
            showMessage('Predikce byla upravena podle va≈°eho odhadu', 'success');
        }

        function saveCurrentPrediction() {
            if (!lastPrediction) {
                showMessage('Nejprve vytvo≈ôte predikci', 'error');
                return;
            }
            
            // Validate required fields
            if (!lastPrediction.eventName || !lastPrediction.location || !lastPrediction.date) {
                showMessage('Vypl≈àte n√°zev akce, lokalitu a datum', 'error');
                return;
            }
            
            // Generate unique ID
            const eventId = generateEventId(lastPrediction.eventName, lastPrediction.date, lastPrediction.location);
            
            // Check if event already exists
            const existingIndex = localSavedEvents.findIndex(e => e.id === eventId);
            
            // Get a color for the event
            const colorIndex = localSavedEvents.filter(e => new Date(e.date) >= new Date()).length % eventColors.length;
            
            // Create event object
            const event = {
                ...lastPrediction,
                id: eventId,
                savedAt: new Date().toISOString(),
                color: eventColors[colorIndex],
                source: 'local'
            };
            
            if (existingIndex >= 0) {
                // Update existing event
                localSavedEvents[existingIndex] = event;
                showMessage('Predikce byla aktualizov√°na v kalend√°≈ôi', 'success');
            } else {
                // Add new event
                localSavedEvents.push(event);
                showMessage('Predikce byla ulo≈æena do kalend√°≈ôe', 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('donulandEvents', JSON.stringify(localSavedEvents));
            
            // Show success and offer to create new prediction
            setTimeout(() => {
                if (confirm('Chcete vytvo≈ôit novou predikci? (souƒçasn√° bude vymaz√°na z formul√°≈ôe)')) {
                    resetPredictionForm();
                }
            }, 1500);
        }

        function resetPredictionForm() {
            // Reset form fields
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('expectedVisitors').value = '2000';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
            
            // Reset other fields to defaults
            document.getElementById('eventDuration').value = '2';
            document.getElementById('eventEnvironment').value = 'outdoor';
            
            // Reset financial params to defaults from settings
            loadSettings();
            
            // Reset prediction display
            document.getElementById('predictionResults').innerHTML = 
                '<div class="prediction-loading">üìç Vypl≈àte typ akce a n√°v≈°tƒõvnost pro naƒçten√≠ predikce</div>';
            
            // Clear weather
            document.getElementById('weatherDisplay').innerHTML = 
                '<div class="weather-loading">üìç Vyberte mƒõsto, datum a d√©lku akce pro naƒçten√≠ poƒças√≠</div>';
            document.getElementById('weatherDays').innerHTML = '';
            
            // Clear prediction
            lastPrediction = null;
            window.currentWeatherData = null;
            
            showMessage('Formul√°≈ô byl vyƒçi≈°tƒõn pro novou predikci', 'info');
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced initialization
        function initializePredictionSystem() {
            console.log('üß† Initializing prediction system...');
            
            // Add event listeners for automatic updates
            const inputs = [
                'eventType', 'eventName', 'expectedVisitors', 'eventEnvironment',
                'donutCost', 'sellingPrice', 'otherCosts',
                'fixedRental', 'percentageRental'
            ];
            
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updatePrediction);
                    element.addEventListener('input', debounce(updatePrediction, 500));
                }
            });

            // Business model radio buttons
            document.querySelectorAll('input[name="businessModel"]').forEach(radio => {
                radio.addEventListener('change', updatePrediction);
            });

            console.log('‚úÖ Prediction system initialized');
        }

        // Auto-save form data
        let autoSaveTimeout;
        function autoSaveFormData() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const formData = {
                    eventType: document.getElementById('eventType').value,
                    eventName: document.getElementById('eventName').value,
                    eventLocation: document.getElementById('eventLocation').value,
                    eventDate: document.getElementById('eventDate').value,
                    eventDuration: document.getElementById('eventDuration').value,
                    expectedVisitors: document.getElementById('expectedVisitors').value,
                    eventEnvironment: document.getElementById('eventEnvironment').value,
                    businessModel: document.querySelector('input[name="businessModel"]:checked')?.value,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('donulandFormDraft', JSON.stringify(formData));
            }, 2000);
        }

        function loadFormDraft() {
            const saved = localStorage.getItem('donulandFormDraft');
            if (saved) {
                try {
                    const formData = JSON.parse(saved);
                    const savedDate = new Date(formData.savedAt);
                    const hoursSinceLastSave = (new Date() - savedDate) / (1000 * 60 * 60);
                    
                    // Only restore if saved within last 24 hours
                    if (hoursSinceLastSave < 24 && formData.eventName) {
                        document.getElementById('eventType').value = formData.eventType || '';
                        document.getElementById('eventName').value = formData.eventName || '';
                        document.getElementById('eventLocation').value = formData.eventLocation || '';
                        document.getElementById('eventDate').value = formData.eventDate || '';
                        document.getElementById('eventDuration').value = formData.eventDuration || '2';
                        document.getElementById('expectedVisitors').value = formData.expectedVisitors || '2000';
                        document.getElementById('eventEnvironment').value = formData.eventEnvironment || 'outdoor';
                        
                        if (formData.businessModel) {
                            const radioButton = document.querySelector(`input[name="businessModel"][value="${formData.businessModel}"]`);
                            if (radioButton) radioButton.checked = true;
                        }
                        
                        showMessage('Obnoveny rozpracovan√© √∫daje z minul√© relace', 'info');
                    }
                } catch (e) {
                    console.error('Error loading form draft:', e);
                }
            }
        }

        function setupAutoSave() {
            const inputs = ['eventType', 'eventName', 'eventLocation', 'eventDate', 'eventDuration', 'expectedVisitors', 'eventEnvironment'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', autoSaveFormData);
                    element.addEventListener('change', autoSaveFormData);
                }
            });
            
            document.querySelectorAll('input[name="businessModel"]').forEach(radio => {
                radio.addEventListener('change', autoSaveFormData);
            });
        }
        // =============================================================================
        // ƒå√ÅST 5: CALENDAR SYSTEM AND ANALYTICS
        // =============================================================================
        // P≈ôidejte tyto funkce p≈ôed funkci updateRentalInputs()

        // Calendar functions
        function initializeCalendar() {
            console.log('üìÖ Initializing calendar...');
            renderCalendar();
            updateMonthYearDisplay();
            if (calendarView === 'list') {
                renderEventList();
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('calendarGrid');
            
            // Create calendar if not exists
            if (!calendarGrid) {
                console.warn('Calendar grid not found, calendar will be implemented in next parts');
                return;
            }
            
            // Keep header row (first 7 elements)
            const headerCells = Array.from(calendarGrid.children).slice(0, 7);
            calendarGrid.innerHTML = '';
            headerCells.forEach(cell => calendarGrid.appendChild(cell));
            
            // Add empty cells for days before month starts
            const startDay = firstDay === 0 ? 6 : firstDay - 1; // Convert Sunday=0 to Monday=0
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.style.cssText = 'background: #f8f9fa; padding: 10px;';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.style.cssText = 'background: white; padding: 10px; min-height: 80px; cursor: pointer; position: relative; border: 1px solid transparent;';
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.style.cssText = 'font-weight: bold; margin-bottom: 5px;';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Check for events on this day
                const dayEvents = getEventsForDay(year, month, day);
                if (dayEvents.length > 0) {
                    dayEvents.forEach((event, index) => {
                        if (index < 2) { // Show max 2 events
                            const eventDiv = document.createElement('div');
                            eventDiv.style.cssText = `
                                font-size: 0.8em; 
                                padding: 2px 4px; 
                                margin: 1px 0; 
                                border-radius: 3px; 
                                overflow: hidden; 
                                text-overflow: ellipsis; 
                                white-space: nowrap;
                                background: ${event.color || '#3498db'};
                                color: white;
                                cursor: pointer;
                            `;
                            eventDiv.textContent = event.eventName || 'Akce';
                            eventDiv.onclick = (e) => {
                                e.stopPropagation();
                                showEventDetails(event.id);
                            };
                            dayCell.appendChild(eventDiv);
                        }
                    });
                    
                    if (dayEvents.length > 2) {
                        const moreDiv = document.createElement('div');
                        moreDiv.style.cssText = 'font-size: 0.7em; color: #7f8c8d; text-align: center;';
                        moreDiv.textContent = `+${dayEvents.length - 2} dal≈°√≠`;
                        dayCell.appendChild(moreDiv);
                    }
                }
                
                // Highlight today
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.style.backgroundColor = '#e3f2fd';
                    dayCell.style.border = '2px solid #2196f3';
                }
                
                // Hover effect
                dayCell.onmouseover = () => {
                    if (!dayCell.style.border.includes('2196f3')) {
                        dayCell.style.backgroundColor = '#f5f5f5';
                    }
                };
                dayCell.onmouseout = () => {
                    if (!dayCell.style.border.includes('2196f3')) {
                        dayCell.style.backgroundColor = 'white';
                    }
                };
                
                calendarGrid.appendChild(dayCell);
            }
        }

        function getEventsForDay(year, month, day) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const allEvents = [...localSavedEvents, ...plannedEvents];
            
            return allEvents.filter(event => {
                const eventDate = new Date(event.date);
                const endDate = new Date(eventDate);
                endDate.setDate(endDate.getDate() + ((event.duration || 1) - 1));
                
                const checkDate = new Date(dateStr);
                return checkDate >= eventDate && checkDate <= endDate;
            });
        }

        function updateMonthYearDisplay() {
            const monthNames = ['Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven', 
                               'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'];
            const element = document.getElementById('currentMonthYear');
            if (element) {
                element.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            updateMonthYearDisplay();
        }

        function setCalendarView(view) {
            calendarView = view;
            
            const calendarGrid = document.getElementById('calendarGrid');
            const monthNavigation = document.getElementById('monthNavigation');
            const eventListView = document.getElementById('eventListView');
            const monthViewBtn = document.getElementById('monthView');
            const listViewBtn = document.getElementById('listView');
            
            if (view === 'month') {
                if (calendarGrid) calendarGrid.style.display = 'grid';
                if (monthNavigation) monthNavigation.style.display = 'flex';
                if (eventListView) eventListView.style.display = 'none';
                if (monthViewBtn) monthViewBtn.style.background = '#3498db';
                if (listViewBtn) listViewBtn.style.background = '#95a5a6';
                renderCalendar();
            } else {
                if (calendarGrid) calendarGrid.style.display = 'none';
                if (monthNavigation) monthNavigation.style.display = 'none';
                if (eventListView) eventListView.style.display = 'block';
                if (monthViewBtn) monthViewBtn.style.background = '#95a5a6';
                if (listViewBtn) listViewBtn.style.background = '#3498db';
                renderEventList();
            }
        }

        function renderEventList() {
            const listDiv = document.getElementById('eventList');
            if (!listDiv) return;
            
            const allEvents = [...localSavedEvents, ...plannedEvents];
            
            if (allEvents.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">≈Ω√°dn√© ulo≈æen√© akce</p>';
                return;
            }
            
            // Sort events by date
            const sortedEvents = [...allEvents].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '<div style="display: grid; gap: 15px;">';
            sortedEvents.forEach(event => {
                const eventDate = new Date(event.date);
                const isPast = eventDate < new Date();
                const isSheetEvent = event.source === 'sheet';
                
                html += `
                    <div class="event-list-item" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 8px; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        cursor: pointer;
                        transition: all 0.3s;
                        opacity: ${isPast ? '0.7' : '1'};
                        border-left: 5px solid ${event.color || '#3498db'};
                        ${isSheetEvent ? 'border-right: 3px solid #f39c12;' : ''}
                    " onclick="showEventDetails('${event.id}')" 
                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">
                                    ${event.eventName}
                                    ${isSheetEvent ? '<span style="font-size: 0.7em; background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 8px;">SHEET</span>' : ''}
                                </h4>
                                <div style="color: #7f8c8d; font-size: 0.9em;">
                                    <div>üìÖ ${eventDate.toLocaleDateString('cs-CZ')} (${event.duration || 1} ${(event.duration || 1) === 1 ? 'den' : 'dn√≠'})</div>
                                    <div>üìç ${event.location}</div>
                                    <div>üé™ ${event.eventType || event.category || 'N/A'}</div>
                                    <div>üë• ${(event.expectedVisitors || event.attendance || 0).toLocaleString('cs-CZ')} n√°v≈°tƒõvn√≠k≈Ø</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                ${event.predictedSales ? `
                                    <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">
                                        ${event.predictedSales.toLocaleString('cs-CZ')} ks
                                    </div>
                                    <div style="color: ${event.financials && event.financials.profit >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                                        ${event.financials ? (event.financials.profit >= 0 ? '+' : '') + Math.round(event.financials.profit).toLocaleString('cs-CZ') + ' Kƒç' : 'N/A'}
                                    </div>
                                    <div style="font-size: 0.8em; color: #95a5a6; margin-top: 5px;">
                                        Spolehlivost: ${event.confidence || 'N/A'}%
                                    </div>
                                ` : `
                                    <div style="font-size: 1.2em; font-weight: bold; color: #7f8c8d;">
                                        ${event.actualSales ? event.actualSales + ' ks prod√°no' : 'Pl√°novan√° akce'}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
        }

        function showEventDetails(eventId) {
            console.log('Showing event details for:', eventId);
            showMessage('Detail akce - implementov√°no v dal≈°√≠ ƒç√°sti', 'info');
        }

        function exportCalendar() {
            const allEvents = [...localSavedEvents, ...plannedEvents];
            
            if (allEvents.length === 0) {
                showMessage('≈Ω√°dn√© akce k exportu', 'error');
                return;
            }
            
            // Create CSV content
            const headers = [
                'N√°zev akce', 'Datum', 'D√©lka (dny)', 'M√≠sto', 'Typ akce', 'Zdroj',
                'Oƒçek√°van√≠ n√°v≈°tƒõvn√≠ci', 'Predikce prodeje (ks)', 'Skuteƒçn√Ω prodej (ks)', 'Spolehlivost (%)',
                'Oƒçek√°van√Ω obrat (Kƒç)', 'Oƒçek√°van√Ω zisk (Kƒç)', 'Mar≈æe (%)', 'Hodnocen√≠ (1-5)'
            ];
            
            const rows = allEvents.map(event => [
                event.eventName || '',
                event.date || '',
                event.duration || 1,
                event.location || '',
                event.eventType || event.category || '',
                event.source === 'sheet' ? 'Google Sheet' : 'Lok√°ln√≠ predikce',
                event.expectedVisitors || event.attendance || 0,
                event.predictedSales || '',
                event.actualSales || '',
                event.confidence || '',
                event.financials ? Math.round(event.financials.revenue) : '',
                event.financials ? Math.round(event.financials.profit) : '',
                event.financials ? event.financials.margin.toFixed(1) : '',
                event.rating || ''
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `donuland_kalendar_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showMessage('Kalend√°≈ô byl exportov√°n do CSV', 'success');
        }

        // Analytics functions
        function loadAnalytics() {
            const analyticsContent = document.getElementById('analyticsContent');
            
            if (historicalData.length === 0) {
                analyticsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <h4>üìä Anal√Ωza prodejn√≠ch dat</h4>
                        <p>Zat√≠m nejsou dostupn√° ≈æ√°dn√° historick√° data pro anal√Ωzu.</p>
                        <p>Data se naƒçtou automaticky z Google Sheetu.</p>
                        <button class="btn btn-primary" onclick="loadData()">üîÑ Naƒç√≠st data ze Sheetu</button>
                    </div>
                `;
                return;
            }
            
            // Calculate basic analytics
            const totalEvents = historicalData.length;
            const totalSales = historicalData.reduce((sum, event) => sum + event.actualSales, 0);
            const avgSales = totalSales / totalEvents;
            const bestEvent = historicalData.reduce((best, event) => 
                event.actualSales > (best?.actualSales || 0) ? event : best, null);
            
            // Event type analysis
            const typeStats = {};
            historicalData.forEach(event => {
                const type = event.category || 'Ostatn√≠';
                if (!typeStats[type]) {
                    typeStats[type] = { count: 0, totalSales: 0 };
                }
                typeStats[type].count++;
                typeStats[type].totalSales += event.actualSales;
            });
            
            // Location analysis
            const locationStats = {};
            historicalData.forEach(event => {
                const location = event.location || 'Nezn√°m√°';
                if (!locationStats[location]) {
                    locationStats[location] = { count: 0, totalSales: 0 };
                }
                locationStats[location].count++;
                locationStats[location].totalSales += event.actualSales;
            });
            
            let analyticsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0; font-size: 2em;">${totalEvents}</h3>
                        <p style="margin: 5px 0 0 0;">Celkem akc√≠</p>
                    </div>
                    <div style="background: #27ae60; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0; font-size: 2em;">${totalSales.toLocaleString('cs-CZ')}</h3>
                        <p style="margin: 5px 0 0 0;">Celkem prod√°no (ks)</p>
                    </div>
                    <div style="background: #f39c12; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0; font-size: 2em;">${Math.round(avgSales).toLocaleString('cs-CZ')}</h3>
                        <p style="margin: 5px 0 0 0;">Pr≈Ømƒõr na akci (ks)</p>
                    </div>
                    <div style="background: #9b59b6; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0; font-size: 1.5em;">${bestEvent?.actualSales || 0}</h3>
                        <p style="margin: 5px 0 0 0;">Nejlep≈°√≠ akce (ks)</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìä Prodej podle typu akce</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            Object.entries(typeStats)
                .sort((a, b) => b[1].totalSales - a[1].totalSales)
                .forEach(([type, stats]) => {
                    const avgForType = Math.round(stats.totalSales / stats.count);
                    analyticsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                            <span><strong>${type}</strong> (${stats.count}x)</span>
                            <span>${stats.totalSales.toLocaleString('cs-CZ')} ks (√∏ ${avgForType})</span>
                        </div>
                    `;
                });
            
            analyticsHtml += `
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìç Prodej podle lokality</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            Object.entries(locationStats)
                .sort((a, b) => b[1].totalSales - a[1].totalSales)
                .slice(0, 10) // Show top 10 locations
                .forEach(([location, stats]) => {
                    const avgForLocation = Math.round(stats.totalSales / stats.count);
                    analyticsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                            <span><strong>${location}</strong> (${stats.count}x)</span>
                            <span>${stats.totalSales.toLocaleString('cs-CZ')} ks (√∏ ${avgForLocation})</span>
                        </div>
                    `;
                });
            
            analyticsHtml += `
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="loadData()">üîÑ Aktualizovat data</button>
                    <button class="btn btn-primary" onclick="exportAnalytics()" style="margin-left: 10px;">üì§ Export anal√Ωzy</button>
                </div>
            `;
            
            analyticsContent.innerHTML = analyticsHtml;
        }

        function exportAnalytics() {
            if (historicalData.length === 0) {
                showMessage('≈Ω√°dn√° data k exportu', 'error');
                return;
            }
            
            const headers = [
                'N√°zev akce', 'Datum', 'Lokalita', 'Kategorie', 'N√°v≈°tƒõvnost',
                'Skuteƒçn√Ω prodej', 'Odhadovan√Ω prodej', 'P≈ôesnost (%)', 'Hodnocen√≠', 'Poƒças√≠'
            ];
            
            const rows = historicalData.map(event => {
                const accuracy = event.estimatedSales > 0 ? 
                    Math.round((event.actualSales / event.estimatedSales) * 100) : '';
                
                return [
                    event.eventName || '',
                    event.eventDate ? event.eventDate.toLocaleDateString('cs-CZ') : '',
                    event.location || '',
                    event.category || '',
                    event.attendance || '',
                    event.actualSales || '',
                    event.estimatedSales || '',
                    accuracy,
                    event.rating || '',
                    event.weather || ''
                ];
            });
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `donuland_analyza_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showMessage('Anal√Ωza byla exportov√°na do CSV', 'success');
        }

        // Enhanced initialization - update the DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Donuland Management System...');
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
            
            // Initialize all systems
            loadData();
            loadSettings();
            initializePredictionSystem();
            setupAutoSave();
            loadFormDraft();
            
            // Auto-refresh data every 10 minutes
            setInterval(loadData, 10 * 60 * 1000);
            
            showMessage('Aplikace byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
        });
        // =============================================================================
        // ƒå√ÅST 6: EVENT MODALS AND FINAL FUNCTIONS
        // =============================================================================
        // P≈ôidejte tyto funkce p≈ôed funkci updateRentalInputs()

        function showEventDetails(eventId) {
            // Find event in both local and sheet events
            let event = localSavedEvents.find(e => e.id === eventId);
            if (!event) {
                event = plannedEvents.find(e => e.id === eventId);
            }
            
            if (!event) {
                showMessage('Akce nebyla nalezena', 'error');
                return;
            }
            
            selectedEventId = eventId;
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            
            const eventDate = new Date(event.date);
            const endDate = new Date(eventDate);
            endDate.setDate(endDate.getDate() + ((event.duration || 1) - 1));
            
            const isSheetEvent = event.source === 'sheet';
            
            let weatherHtml = '';
            if (event.weather && event.weather.dayDetails) {
                weatherHtml = '<h4>üå§Ô∏è Poƒças√≠ bƒõhem akce:</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">';
                event.weather.dayDetails.forEach(day => {
                    weatherHtml += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>Den ${day.day}</strong>
                            <div>üå°Ô∏è ${Math.round(day.temp)}¬∞C</div>
                            <div>üíß ${day.rain.toFixed(1)} mm</div>
                            <div style="font-size: 0.85em;">${day.description}</div>
                        </div>
                    `;
                });
                weatherHtml += '</div>';
            }
            
            content.innerHTML = `
                <h2 style="color: #2c3e50; margin-bottom: 20px;">
                    ${event.eventName}
                    ${isSheetEvent ? '<span style="font-size: 0.6em; background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">ZE SHEETU</span>' : ''}
                </h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4>üìã Z√°kladn√≠ informace:</h4>
                        <div style="line-height: 1.8;">
                            <div>üìÖ <strong>Datum:</strong> ${eventDate.toLocaleDateString('cs-CZ')} - ${endDate.toLocaleDateString('cs-CZ')}</div>
                            <div>üìç <strong>M√≠sto:</strong> ${event.location}</div>
                            <div>üé™ <strong>Typ:</strong> ${event.eventType || event.category || 'N/A'}</div>
                            <div>üë• <strong>N√°v≈°tƒõvnost:</strong> ${(event.expectedVisitors || event.attendance || 0).toLocaleString('cs-CZ')}</div>
                            <div>‚è±Ô∏è <strong>D√©lka:</strong> ${event.duration || 1} ${(event.duration || 1) === 1 ? 'den' : 'dn√≠'}</div>
                            ${event.businessModel ? `<div>üíº <strong>Model:</strong> ${event.businessModel}</div>` : ''}
                        </div>
                    </div>
                    
                    ${event.predictedSales ? `
                        <div>
                            <h4>üìä Predikce prodeje:</h4>
                            <div style="line-height: 1.8;">
                                <div>üç© <strong>Predikce:</strong> ${event.predictedSales.toLocaleString('cs-CZ')} ks</div>
                                <div>üìä <strong>Spolehlivost:</strong> ${event.confidence || 'N/A'}%</div>
                                ${event.financials ? `
                                    <div>üí∞ <strong>Oƒçek√°van√Ω obrat:</strong> ${Math.round(event.financials.revenue).toLocaleString('cs-CZ')} Kƒç</div>
                                    <div style="color: ${event.financials.profit >= 0 ? '#27ae60' : '#e74c3c'}">
                                        üíµ <strong>Oƒçek√°van√Ω zisk:</strong> ${Math.round(event.financials.profit).toLocaleString('cs-CZ')} Kƒç
                                    </div>
                                    <div>üìà <strong>Mar≈æe:</strong> ${event.financials.margin.toFixed(1)}%</div>
                                ` : ''}
                            </div>
                        </div>
                    ` : `
                        <div>
                            <h4>üìà Historick√© √∫daje:</h4>
                            <div style="line-height: 1.8;">
                                ${event.actualSales ? `<div>‚úÖ <strong>Skuteƒçn√Ω prodej:</strong> ${event.actualSales} ks</div>` : ''}
                                ${event.estimatedSales ? `<div>üéØ <strong>Odhadovan√Ω prodej:</strong> ${event.estimatedSales} ks</div>` : ''}
                                ${event.rating ? `<div>‚≠ê <strong>Hodnocen√≠:</strong> ${event.rating}/5</div>` : ''}
                                ${event.notes ? `<div>üìù <strong>Pozn√°mky:</strong> ${event.notes}</div>` : ''}
                            </div>
                        </div>
                    `}
                </div>
                
                ${weatherHtml}
                
                ${event.financials ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4>üí∞ Finanƒçn√≠ rozpis:</h4>
                        <div style="display: grid; gap: 8px;">
                            <div>üì¶ N√°klady na donuty: ${Math.round(event.financials.donutsCost || 0).toLocaleString('cs-CZ')} Kƒç</div>
                            <div>üè™ N√°jem m√≠sta: ${Math.round(event.financials.rentalCost || 0).toLocaleString('cs-CZ')} Kƒç</div>
                            <div>üöö Doprava: ${event.transportCost || 0} Kƒç</div>
                            <div>üíº Ostatn√≠ n√°klady: ${(event.financials.totalCosts || 0) - (event.financials.donutsCost || 0) - (event.financials.rentalCost || 0) - (event.transportCost || 0)} Kƒç</div>
                            <div style="border-top: 1px solid #ddd; padding-top: 5px; margin-top: 5px;">
                                <strong>üí∏ Celkov√© n√°klady: ${Math.round(event.financials.totalCosts || 0).toLocaleString('cs-CZ')} Kƒç</strong>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 15px; font-size: 0.9em; color: #7f8c8d;">
                    <em>
                        ${isSheetEvent ? 'Naƒçteno ze Sheetu' : `Ulo≈æeno: ${new Date(event.savedAt).toLocaleString('cs-CZ')}`}
                        ${event.isManualOverride ? ' | Upraveno ruƒçnƒõ' : ''}
                    </em>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            selectedEventId = null;
        }

        function deleteEvent() {
            if (!selectedEventId) return;
            
            // Find event to check if it's from sheet
            const event = localSavedEvents.find(e => e.id === selectedEventId) || 
                         plannedEvents.find(e => e.id === selectedEventId);
            
            if (event && event.source === 'sheet') {
                showMessage('Nelze smazat akci ze Sheetu', 'error');
                return;
            }
            
            if (confirm('Opravdu chcete smazat tuto akci z kalend√°≈ôe?')) {
                localSavedEvents = localSavedEvents.filter(e => e.id !== selectedEventId);
                localStorage.setItem('donulandEvents', JSON.stringify(localSavedEvents));
                
                closeEventModal();
                
                if (calendarView === 'month') {
                    renderCalendar();
                } else {
                    renderEventList();
                }
                
                showMessage('Akce byla smaz√°na z kalend√°≈ôe', 'success');
            }
        }

        async function syncToSheet() {
            showMessage('Synchronizace se Sheetem zat√≠m nen√≠ implementov√°na', 'info');
            // TODO: Implement Google Sheets API integration for writing data
            // This would require authentication and Google Sheets API setup
        }

        // Enhanced showTab function with calendar initialization
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Initialize specific tab content
            if (tabName === 'calendar') {
                initializeCalendar();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Enhanced updateSettings with prediction refresh
        function saveSettings() {
            const settings = {
                defaultDonutPrice: document.getElementById('defaultDonutPrice').value,
                defaultDonutCost: document.getElementById('defaultDonutCost').value,
                defaultTransportRate: document.getElementById('defaultTransportRate').value
            };
            
            localStorage.setItem('donulandSettings', JSON.stringify(settings));
            
            // Update current form values
            document.getElementById('sellingPrice').value = settings.defaultDonutPrice;
            document.getElementById('donutCost').value = settings.defaultDonutCost;
            
            showMessage('Nastaven√≠ bylo ulo≈æeno', 'success');
            
            // Recalculate prediction if active
            if (lastPrediction) {
                updatePrediction();
            }
        }

        // Enhanced loadSettings
        function loadSettings() {
            const saved = localStorage.getItem('donulandSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    
                    // Update settings form
                    document.getElementById('defaultDonutPrice').value = settings.defaultDonutPrice || 45;
                    document.getElementById('defaultDonutCost').value = settings.defaultDonutCost || 15;
                    document.getElementById('defaultTransportRate').value = settings.defaultTransportRate || 10;
                    
                    // Update prediction form
                    document.getElementById('sellingPrice').value = settings.defaultDonutPrice || 45;
                    document.getElementById('donutCost').value = settings.defaultDonutCost || 15;
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save prediction
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (lastPrediction) {
                    saveCurrentPrediction();
                }
            }
            
            // Ctrl/Cmd + R to reset form
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                if (confirm('Opravdu chcete vymazat formul√°≈ô?')) {
                    resetPredictionForm();
                }
            }
            
            // ESC to close modal
            if (e.key === 'Escape') {
                const modal = document.getElementById('eventModal');
                if (modal && modal.style.display === 'block') {
                    closeEventModal();
                }
            }
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showMessage('Do≈°lo k neoƒçek√°van√© chybƒõ aplikace', 'error');
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showMessage('Chyba p≈ôi komunikaci se serverem', 'error');
        });

        // Performance tracking
        function trackPerformance(action, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            console.log(`‚è±Ô∏è ${action} took ${duration.toFixed(2)}ms`);
            
            // Log slow operations
            if (duration > 1000) {
                console.warn(`‚ö†Ô∏è Slow operation detected: ${action} (${duration.toFixed(2)}ms)`);
            }
        }

        // Cleanup function
        function cleanup() {
            // Clear auto-save timeout
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
        }

        // Setup cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Final initialization message
        console.log(`
        üç© Donuland Management System v2.0
        ===================================
        ‚úÖ Data loading: Aktivn√≠
        ‚úÖ Weather API: Aktivn√≠
        ‚úÖ AI Predikce: Aktivn√≠
        ‚úÖ Kalend√°≈ô: Aktivn√≠
        ‚úÖ Analytics: Aktivn√≠
        ‚úÖ Export: Aktivn√≠
        
        Syst√©m je p≈ôipraven k pou≈æit√≠! üöÄ
        `);
        
        function updateRentalInputs() {
            const model = document.getElementById('rentalModel').value;
            const fixedRow = document.getElementById('fixedRentalRow');
            const percentageRow = document.getElementById('percentageRentalRow');
            
            if (model === 'fixed') {
                fixedRow.style.display = 'flex';
                percentageRow.style.display = 'none';
            } else if (model === 'percentage') {
                fixedRow.style.display = 'none';
                percentageRow.style.display = 'flex';
            } else {
                fixedRow.style.display = 'flex';
                percentageRow.style.display = 'flex';
            }
        }

        function saveSettings() {
            const settings = {
                defaultDonutPrice: document.getElementById('defaultDonutPrice').value,
                defaultDonutCost: document.getElementById('defaultDonutCost').value,
                defaultTransportRate: document.getElementById('defaultTransportRate').value
            };
            
            localStorage.setItem('donulandSettings', JSON.stringify(settings));
            showMessage('Nastaven√≠ bylo ulo≈æeno', 'success');
        }

        function loadSettings() {
            const saved = localStorage.getItem('donulandSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('defaultDonutPrice').value = settings.defaultDonutPrice || 45;
                document.getElementById('defaultDonutCost').value = settings.defaultDonutCost || 15;
                document.getElementById('defaultTransportRate').value = settings.defaultTransportRate || 10;
                document.getElementById('sellingPrice').value = settings.defaultDonutPrice || 45;
                document.getElementById('donutCost').value = settings.defaultDonutCost || 15;
            }
        }
    </script>
</body>
</html>
